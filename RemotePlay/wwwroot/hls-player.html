<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayStation Remote Play - HLS Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        video {
            width: 100%;
            height: auto;
            display: block;
            min-height: 400px;
        }

        .video-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            text-align: center;
            font-size: 1.2em;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        input[type="text"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            height: 44px;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #11998e;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            min-width: 150px;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 44px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(235, 51, 73, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #666;
        }

        .status-value {
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .status-connected {
            color: #11998e;
            font-weight: 600;
        }

        .status-disconnected {
            color: #eb3349;
            font-weight: 600;
        }

        .logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info {
            color: #4fc3f7;
        }

        .log-success {
            color: #81c784;
        }

        .log-error {
            color: #e57373;
        }

        .log-warning {
            color: #ffb74d;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .url-input-group input[type="text"] {
            flex: 1;
        }

        .url-input-group button {
            flex-shrink: 0;
            white-space: nowrap;
        }

        .controller-section {
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .controller-wrapper {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .controller-shoulder-row {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .controller-center-space {
            flex: 1;
            min-width: 100px;
        }

        .controller-main-area {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .controller-left,
        .controller-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .controller-dpad-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controller-dpad {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .controller-dpad-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .controller-face-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .controller-face-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .controller-function-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .controller-btn {
            min-width: 60px;
            height: 60px;
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: 600;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controller-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border-color: #11998e;
        }

        .controller-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .controller-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .controller-btn-small {
            min-width: 80px;
            height: 44px;
            font-size: 0.9em;
            padding: 8px 15px;
        }

        .controller-btn-shoulder {
            min-width: 70px;
            height: 50px;
            font-size: 0.85em;
            padding: 8px 15px;
            background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
        }

        .controller-btn-dpad {
            min-width: 50px;
            height: 50px;
            font-size: 1.2em;
            padding: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .controller-btn-face {
            min-width: 70px;
            height: 70px;
            font-size: 1.5em;
            padding: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
        }

        .controller-btn-function {
            min-width: 90px;
            height: 40px;
            font-size: 0.75em;
            padding: 6px 12px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                gap: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                min-width: 100%;
                width: 100%;
            }

            .url-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .url-input-group input[type="text"] {
                width: 100%;
            }

            .url-input-group button {
                width: 100%;
            }

            .controller-btn {
                min-width: 50px;
                height: 50px;
                font-size: 1em;
            }

            .controller-btn-small {
                min-width: 70px;
                height: 40px;
                font-size: 0.8em;
            }

            .controller-main-area {
                flex-direction: column;
                gap: 20px;
            }

            .controller-shoulder-row {
                flex-wrap: wrap;
                justify-content: center;
            }

            .controller-center-space {
                display: none;
            }

            .controller-btn-shoulder {
                min-width: 60px;
                height: 45px;
                font-size: 0.75em;
            }

            .controller-btn-dpad {
                min-width: 45px;
                height: 45px;
                font-size: 1em;
            }

            .controller-btn-face {
                min-width: 60px;
                height: 60px;
                font-size: 1.2em;
            }

            .controller-btn-function {
                min-width: 80px;
                height: 38px;
                font-size: 0.7em;
            }
        }
    </style>
    <!-- HLS.js åº“ç”¨äºæ’­æ”¾ HLS æµ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- SignalR åº“ç”¨äºä½å»¶è¿Ÿæ§åˆ¶å™¨è¾“å…¥ -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“º PlayStation Remote Play</h1>
            <p>HLS æµåª’ä½“æ’­æ”¾å™¨</p>
        </div>

        <div class="content">
            <div class="controller-section" id="authSection">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ” èº«ä»½éªŒè¯</h3>
                <div class="input-group">
                    <label for="authTokenInput">JWT Token</label>
                    <div class="url-input-group">
                        <input type="password" id="authTokenInput" placeholder="ç²˜è´´ Bearer Tokenï¼Œæˆ–ç›´æ¥è¾“å…¥ JWT å­—ç¬¦ä¸²">
                        <button class="btn-primary" onclick="saveAuthToken()">ä¿å­˜</button>
                        <button class="btn-danger" onclick="clearAuthToken()">æ¸…é™¤</button>
                    </div>
                    <small id="authTokenStatus" style="color: #666; font-size: 0.85em;">
                        å½“å‰æœªé…ç½® Tokenã€‚
                    </small>
                </div>
            </div>

            <div class="video-container">
                <video id="hlsVideo" controls autoplay playsinline></video>
                <div class="video-placeholder" id="placeholder">
                    ç­‰å¾…æ’­æ”¾...
                </div>
            </div>

            <div class="controller-section">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ® PS5 æ§åˆ¶å™¨</h3>
                <div style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 5px; font-size: 0.9em; color: #666;">
                    <strong>âŒ¨ï¸ é”®ç›˜æ˜ å°„ï¼š</strong>
                    <span style="margin-left: 10px;">WASD/æ–¹å‘é”® = æ–¹å‘é”®</span>
                    <span style="margin-left: 10px;">ç©ºæ ¼ = âœ•</span>
                    <span style="margin-left: 10px;">Enter = â—‹</span>
                    <span style="margin-left: 10px;">Shift = â–¡</span>
                    <span style="margin-left: 10px;">Ctrl = â–³</span>
                    <span style="margin-left: 10px;">Q = L1</span>
                    <span style="margin-left: 10px;">E = R1</span>
                    <span style="margin-left: 10px;">Z = L2</span>
                    <span style="margin-left: 10px;">C = R2</span>
                    <span style="margin-left: 10px;">Tab = OPTIONS</span>
                    <span style="margin-left: 10px;">Backspace = SHARE</span>
                    <span style="margin-left: 10px;">Esc = PS</span>
                </div>
                <div class="controller-wrapper">
                    <!-- è‚©é”®åŒºåŸŸ -->
                    <div class="controller-shoulder-row">
                        <button class="controller-btn controller-btn-shoulder" data-button="L1" title="L1">L1</button>
                        <button class="controller-btn controller-btn-shoulder" data-button="L2" title="L2">L2</button>
                        <div class="controller-center-space"></div>
                        <button class="controller-btn controller-btn-shoulder" data-button="R1" title="R1">R1</button>
                        <button class="controller-btn controller-btn-shoulder" data-button="R2" title="R2">R2</button>
                    </div>
                    
                    <!-- ä¸»è¦æ§åˆ¶åŒºåŸŸ -->
                    <div class="controller-main-area">
                        <!-- å·¦ä¾§ï¼šæ–¹å‘é”® -->
                        <div class="controller-left">
                            <div class="controller-dpad-container">
                                <div class="controller-dpad">
                                    <button class="controller-btn controller-btn-dpad" data-button="UP" title="ä¸Š">â†‘</button>
                                    <div class="controller-dpad-row">
                                        <button class="controller-btn controller-btn-dpad" data-button="LEFT" title="å·¦">â†</button>
                                        <button class="controller-btn controller-btn-dpad" data-button="DOWN" title="ä¸‹">â†“</button>
                                        <button class="controller-btn controller-btn-dpad" data-button="RIGHT" title="å³">â†’</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šä¸»è¦æŒ‰é’® -->
                        <div class="controller-right">
                            <div class="controller-face-buttons">
                                <button class="controller-btn controller-btn-face" data-button="TRIANGLE" title="ä¸‰è§’é”®">â–³</button>
                                <div class="controller-face-row">
                                    <button class="controller-btn controller-btn-face" data-button="SQUARE" title="æ–¹å—é”®">â–¡</button>
                                    <button class="controller-btn controller-btn-face" data-button="CROSS" title="å‰é”®">âœ•</button>
                                    <button class="controller-btn controller-btn-face" data-button="CIRCLE" title="åœ†åœˆé”®">â—‹</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŠŸèƒ½é”®åŒºåŸŸ -->
                    <div class="controller-function-row">
                        <button class="controller-btn controller-btn-function" data-button="OPTIONS" title="é€‰é¡¹">OPTIONS</button>
                        <button class="controller-btn controller-btn-function" data-button="SHARE" title="åˆ†äº«">SHARE</button>
                        <button class="controller-btn controller-btn-function" data-button="PS" title="PS é”®">PS</button>
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="input-group">
                    <label for="hostId">ä¸»æœº ID (Host ID)</label>
                    <div class="url-input-group">
                        <input type="text" id="hostId" placeholder="è¾“å…¥ä¸»æœº IDï¼Œå°†è‡ªåŠ¨å¯åŠ¨ HLS æµ">
                        <button class="btn-primary" id="connectBtn" onclick="connectAndPlay()">
                            ğŸ”Œ è¿æ¥å¹¶æ’­æ”¾
                        </button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="hlsUrl">æˆ–ç›´æ¥è¾“å…¥ HLS æµåœ°å€ (å®Œæ•´ URL æˆ– Session ID)</label>
                    <div class="url-input-group">
                        <input type="text" id="hlsUrl" placeholder="è¾“å…¥ HLS URL æˆ– Session ID">
                        <button class="btn-primary" id="playBtn" onclick="playStream()">
                            â–¶ï¸ æ’­æ”¾
                        </button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-danger" id="stopBtn" onclick="stopStream()" disabled>
                    â¹ï¸ åœæ­¢
                </button>
                <button class="btn-success" id="refreshBtn" onclick="refreshStream()" disabled>
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <div class="status">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š æ’­æ”¾çŠ¶æ€</h3>
                <div class="status-item">
                    <span class="status-label">å½“å‰æµåœ°å€:</span>
                    <span class="status-value" id="currentUrl">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ’­æ”¾çŠ¶æ€:</span>
                    <span class="status-value status-disconnected" id="playbackState">æœªæ’­æ”¾</span>
                </div>
                <div class="status-item">
                    <span class="status-label">HLS.js çŠ¶æ€:</span>
                    <span class="status-value" id="hlsState">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">è§†é¢‘å°±ç»ª:</span>
                    <span class="status-value" id="videoReady">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">é”™è¯¯ä¿¡æ¯:</span>
                    <span class="status-value" id="errorInfo">-</span>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ“ æ—¥å¿—</h3>
                <div class="logs" id="logs"></div>
            </div>
        </div>
    </div>

    <script>
        const AUTH_STORAGE_KEY = 'remoteplay.authToken';
        let authToken = localStorage.getItem(AUTH_STORAGE_KEY) || '';
        let warnedAuthMissing = false;

        function getAuthToken() {
            return authToken?.trim() || '';
        }

        function setAuthToken(token) {
            authToken = (token || '').trim();
            if (authToken) {
                localStorage.setItem(AUTH_STORAGE_KEY, authToken);
            } else {
                localStorage.removeItem(AUTH_STORAGE_KEY);
            }
            warnedAuthMissing = false;
            updateAuthTokenStatus();
        }

        function updateAuthTokenStatus() {
            const statusEl = document.getElementById('authTokenStatus');
            const inputEl = document.getElementById('authTokenInput');
            if (!statusEl || !inputEl) {
                return;
            }
            if (authToken) {
                statusEl.textContent = `Token å·²ä¿å­˜ï¼ˆé•¿åº¦ ${authToken.length}ï¼‰`;
                statusEl.style.color = '#11998e';
                inputEl.value = authToken;
            } else {
                statusEl.textContent = 'å½“å‰æœªé…ç½® Tokenã€‚';
                statusEl.style.color = '#666';
                inputEl.value = '';
            }
        }

        function saveAuthToken() {
            const input = document.getElementById('authTokenInput');
            setAuthToken(input?.value || '');
            if (authToken) {
                log('âœ… Token å·²ä¿å­˜', 'success');
            } else {
                log('âœ… Token å·²æ¸…ç©º', 'info');
            }
        }

        function clearAuthToken() {
            setAuthToken('');
            log('âœ… Token å·²æ¸…ç©º', 'info');
        }

        function authorizedFetch(url, options = {}) {
            const headers = new Headers(options.headers || {});
            const token = getAuthToken();
            if (token) {
                headers.set('Authorization', `Bearer ${token}`);
                warnedAuthMissing = false;
            } else if (!warnedAuthMissing) {
                log('âš ï¸ å°šæœªè®¾ç½® JWT Tokenï¼Œè¯·åœ¨â€œèº«ä»½éªŒè¯â€ä¸­é…ç½®', 'warning');
                warnedAuthMissing = true;
            }
            return fetch(url, { ...options, headers });
        }

        let hls = null;
        let currentStreamUrl = null;
        let currentSessionId = null; // å½“å‰ä¼šè¯ IDï¼Œç”¨äºæ§åˆ¶å™¨
        const video = document.getElementById('hlsVideo');
        
        // SignalR è¿æ¥ï¼ˆç”¨äºä½å»¶è¿Ÿæ§åˆ¶å™¨è¾“å…¥ï¼‰
        let controllerConnection = null;
        let controllerConnected = false;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(field, value, isConnected = null) {
            const element = document.getElementById(field);
            if (element) {
                element.textContent = value || '-';
                if (isConnected !== null && field === 'playbackState') {
                    element.className = isConnected ? 'status-value status-connected' : 'status-value status-disconnected';
                }
            }
        }

        function normalizeHlsUrl(input) {
            if (!input || !input.trim()) {
                return null;
            }

            const trimmed = input.trim();

            // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„ URLï¼Œç›´æ¥è¿”å›
            if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {
                return trimmed;
            }

            // å¦‚æœæ˜¯ Session IDï¼Œæ„å»ºå®Œæ•´çš„ HLS URL
            const baseUrl = window.location.origin;
            return `${baseUrl}/hls/${trimmed}/index.m3u8`;
        }

        async function connectAndPlay() {
            try {
                const hostId = document.getElementById('hostId').value.trim();
                if (!hostId) {
                    alert('è¯·è¾“å…¥ä¸»æœº ID');
                    return;
                }

                log(`å¼€å§‹è¿æ¥ä¸»æœº: ${hostId}...`, 'info');
                updateStatus('playbackState', 'è¿æ¥ä¸­...', false);
                updateStatus('errorInfo', '-');

                // ç¦ç”¨æŒ‰é’®
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('hostId').disabled = true;

                // 1. å¯åŠ¨ä¼šè¯
                log('æ­£åœ¨å¯åŠ¨ä¼šè¯...', 'info');
                const startSessionResponse = await authorizedFetch(`/api/PlayStation/start-session?hostId=${encodeURIComponent(hostId)}`, {
                    method: 'POST'
                });

                if (!startSessionResponse.ok) {
                    throw new Error(`å¯åŠ¨ä¼šè¯å¤±è´¥: ${startSessionResponse.statusText}`);
                }

                const startSessionResult = await startSessionResponse.json();
                if (!startSessionResult.success) {
                    throw new Error(`å¯åŠ¨ä¼šè¯å¤±è´¥: ${startSessionResult.errorMessage || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const sessionId = startSessionResult.data?.id;
                if (!sessionId) {
                    throw new Error('ä¼šè¯å¯åŠ¨æˆåŠŸï¼Œä½†æœªè¿”å›ä¼šè¯ ID');
                }

                log(`âœ… ä¼šè¯å¯åŠ¨æˆåŠŸ: ${sessionId}`, 'success');
                updateStatus('currentUrl', `Session: ${sessionId}`);
                
                // ä¿å­˜ sessionId ç”¨äºæ§åˆ¶å™¨
                currentSessionId = sessionId;
                
                // è¿æ¥ SignalR æ§åˆ¶å™¨ï¼ˆä½å»¶è¿Ÿï¼‰
                await connectControllerSignalR(sessionId);

                // 2. ç­‰å¾…æµå¯åŠ¨ï¼ˆä¼šè¯å¯èƒ½å·²è‡ªåŠ¨å¯åŠ¨æµï¼Œä½†éœ€è¦ç­‰å¾…ä¸€ä¸‹ï¼‰
                log('ç­‰å¾…æµå¯åŠ¨...', 'info');
                await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾… 5 ç§’

                // 3. ç¡®ä¿æµå·²å¯åŠ¨
              /*  log('æ£€æŸ¥æµçŠ¶æ€...', 'info');
                const startStreamResponse = await authorizedFetch(`/api/PlayStation/start-stream?sessionId=${sessionId}&test=false`, {
                    method: 'POST'
                });
                
                if (startStreamResponse.ok) {
                    const startStreamResult = await startStreamResponse.json();
                    if (startStreamResult.success) {
                        log('âœ… æµå·²å¯åŠ¨', 'success');
                        // å†ç­‰å¾…ä¸€ä¸‹ï¼Œè®©æµç¨³å®š
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        log('âš ï¸ æµå¯åŠ¨å¯èƒ½å¤±è´¥ï¼Œç»§ç»­å°è¯•...', 'warning');
                    }
                }*/

                // 4. å¯åŠ¨ HLS æµ
                log('æ­£åœ¨å¯åŠ¨ HLS æµ...', 'info');
                const shareHlsParams = new URLSearchParams({
                    sessionId: sessionId,
                    segmentTime: '1', 
                    listSize: '6',
                    enableAudio: 'false',
                    useTcp: 'true',
                    enableVideo: 'true'
                });
                const shareHlsResponse = await authorizedFetch(`/api/PlayStation/share-hls?${shareHlsParams.toString()}`, {
                    method: 'POST'
                });

                if (!shareHlsResponse.ok) {
                    throw new Error(`å¯åŠ¨ HLS æµå¤±è´¥: ${shareHlsResponse.statusText}`);
                }

                const shareHlsResult = await shareHlsResponse.json();
                if (!shareHlsResult.success) {
                    const errorMsg = shareHlsResult.errorMessage || 'æœªçŸ¥é”™è¯¯';
                    log(`âš ï¸ é¦–æ¬¡å°è¯•å¯åŠ¨ HLS æµå¤±è´¥: ${errorMsg}`, 'warning');
                    
                    // å¦‚æœå¤±è´¥ï¼Œç­‰å¾… 3 ç§’åé‡è¯•ä¸€æ¬¡
                    log('ç­‰å¾… 3 ç§’åé‡è¯•...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const retryResponse = await authorizedFetch(`/api/PlayStation/share-hls?${shareHlsParams.toString()}`, {
                        method: 'POST'
                    });
                    
                    if (!retryResponse.ok) {
                        throw new Error(`å¯åŠ¨ HLS æµå¤±è´¥: ${retryResponse.statusText}`);
                    }
                    
                    const retryResult = await retryResponse.json();
                    if (!retryResult.success) {
                        const retryErrorMsg = retryResult.errorMessage || 'æœªçŸ¥é”™è¯¯';
                        throw new Error(`å¯åŠ¨ HLS æµå¤±è´¥ï¼ˆé‡è¯•åï¼‰: ${retryErrorMsg}`);
                    }
                    
                    // ä½¿ç”¨é‡è¯•ç»“æœ
                    const retryHlsUrl = retryResult.data?.url;
                    if (!retryHlsUrl) {
                        const baseUrl = window.location.origin;
                        const constructedUrl = `${baseUrl}/hls/${sessionId.replace(/-/g, '')}/index.m3u8`;
                        log(`âœ… HLS æµå¯åŠ¨æˆåŠŸï¼ˆé‡è¯•ï¼‰ï¼Œä½¿ç”¨æ„å»ºçš„ URL: ${constructedUrl}`, 'success');
                        document.getElementById('hlsUrl').value = sessionId.replace(/-/g, '');
                        await playStreamUrl(constructedUrl);
                        return;
                    } else {
                        log(`âœ… HLS æµå¯åŠ¨æˆåŠŸï¼ˆé‡è¯•ï¼‰: ${retryHlsUrl}`, 'success');
                        document.getElementById('hlsUrl').value = retryHlsUrl;
                        await playStreamUrl(retryHlsUrl);
                        return;
                    }
                }

                const hlsUrl = shareHlsResult.data?.url;
                if (!hlsUrl) {
                    // å¦‚æœæ²¡æœ‰è¿”å› URLï¼Œæ ¹æ® sessionId æ„å»º URL
                    const baseUrl = window.location.origin;
                    const constructedUrl = `${baseUrl}/hls/${sessionId.replace(/-/g, '')}/index.m3u8`;
                    log(`âœ… HLS æµå¯åŠ¨æˆåŠŸï¼Œä½¿ç”¨æ„å»ºçš„ URL: ${constructedUrl}`, 'success');
                    
                    // è®¾ç½® URL å¹¶å¼€å§‹æ’­æ”¾
                    document.getElementById('hlsUrl').value = sessionId.replace(/-/g, '');
                    await playStreamUrl(constructedUrl);
                } else {
                    log(`âœ… HLS æµå¯åŠ¨æˆåŠŸ: ${hlsUrl}`, 'success');
                    
                    // è®¾ç½® URL å¹¶å¼€å§‹æ’­æ”¾
                    document.getElementById('hlsUrl').value = hlsUrl;
                    await playStreamUrl(hlsUrl);
                }

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('errorInfo', error.message);
                updateStatus('playbackState', 'è¿æ¥å¤±è´¥', false);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('hostId').disabled = false;
            }
        }

        // ä» HLS URL ä¸­æå– sessionIdï¼ˆè¿”å› GUID æ ¼å¼ï¼‰
        function extractSessionIdFromUrl(url) {
            if (!url) return null;
            
            // å…ˆå°è¯•åŒ¹é… GUID æ ¼å¼ï¼ˆå¸¦è¿å­—ç¬¦ï¼‰
            // æ ¼å¼: /hls/{guid-format}/index.m3u8 æˆ– /hls/{guid-format}
            const guidMatch = url.match(/\/hls\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})(?:\/|$)/i);
            if (guidMatch && guidMatch[1]) {
                return guidMatch[1].toLowerCase(); // è¿”å›æ ‡å‡† GUID æ ¼å¼ï¼ˆå°å†™ï¼‰
            }
            
            // å¦‚æœ URL ä¸­çš„ sessionId æ˜¯32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆæ— è¿å­—ç¬¦ï¼‰ï¼Œè½¬æ¢ä¸º GUID æ ¼å¼
            // æ ¼å¼: /hls/{32-hex-characters}/index.m3u8 æˆ– /hls/{32-hex-characters}
            const hexMatch = url.match(/\/hls\/([a-f0-9]{32})(?:\/|$)/i);
            if (hexMatch && hexMatch[1]) {
                const hex = hexMatch[1].toLowerCase();
                // å°†32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸º GUID æ ¼å¼: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
                return `${hex.substring(0, 8)}-${hex.substring(8, 12)}-${hex.substring(12, 16)}-${hex.substring(16, 20)}-${hex.substring(20, 32)}`;
            }
            
            return null;
        }

        async function playStreamUrl(hlsUrl) {
            // å°è¯•ä» URL ä¸­æå– sessionIdï¼ˆåœ¨åœæ­¢ä¹‹å‰ä¿å­˜ï¼‰
            const extractedSessionId = extractSessionIdFromUrl(hlsUrl);
            
            // è°ƒç”¨ç°æœ‰çš„æ’­æ”¾é€»è¾‘
            currentStreamUrl = hlsUrl;
            updateStatus('currentUrl', hlsUrl);
            updateStatus('playbackState', 'è¿æ¥ä¸­...', false);
            updateStatus('hlsState', 'åˆå§‹åŒ–ä¸­...');
            updateStatus('errorInfo', '-');

            // åœæ­¢å½“å‰æ’­æ”¾ï¼ˆè¿™ä¼šæ¸…é™¤ sessionIdï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¹‹åé‡æ–°è®¾ç½®ï¼‰
            const savedSessionId = currentSessionId; // ä¿å­˜å½“å‰çš„ sessionId
            stopStream();
            
            // æ¢å¤æˆ–è®¾ç½® sessionId
            if (extractedSessionId) {
                currentSessionId = extractedSessionId;
                log(`âœ… ä» URL ä¸­æå–ä¼šè¯ ID: ${extractedSessionId}`, 'success');
                // è¿æ¥ SignalR æ§åˆ¶å™¨ï¼ˆå¦‚æœä» URL æå–åˆ° sessionIdï¼‰
                await connectControllerSignalR(extractedSessionId);
            } else if (savedSessionId) {
                currentSessionId = savedSessionId; // æ¢å¤ä¹‹å‰ä¿å­˜çš„ sessionId
                // è¿æ¥ SignalR æ§åˆ¶å™¨
                await connectControllerSignalR(savedSessionId);
            }

            // å¼ºåˆ¶ä½¿ç”¨ HLS.js
            if (Hls.isSupported()) {
                log('âœ… ä½¿ç”¨ HLS.js æ’­æ”¾', 'info');
                
                // å¦‚æœå·²æœ‰ HLS å®ä¾‹ï¼Œå…ˆé”€æ¯
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    maxBufferSize: 60 * 1000 * 1000,
                    maxBufferHole: 0.5,
                    startLevel: -1,
                    capLevelToPlayerSize: true,
                    debug: true,
                    // å®æ—¶ç›´æ’­é…ç½®ï¼šä»æœ€æ–°ä½ç½®å¼€å§‹æ’­æ”¾ï¼ˆä½¿ç”¨åŸºäºç‰‡æ®µæ•°é‡çš„é…ç½®ï¼‰
                    liveSyncDurationCount: 3, // ä¿æŒ 3 ä¸ªç‰‡æ®µçš„å»¶è¿Ÿï¼ˆæ›´æ¥è¿‘å®æ—¶ï¼‰
                    liveMaxLatencyDurationCount: Infinity, // å…è®¸æ— é™å»¶è¿Ÿï¼ˆæ€»æ˜¯è·Ÿéšæœ€æ–°å†…å®¹ï¼‰
                    xhrSetup: function(xhr, url) {
                        xhr.withCredentials = false;
                    }
                });

                hls.loadSource(hlsUrl);
                hls.attachMedia(video);

                setupHlsEvents();
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾', 'error');
                updateStatus('errorInfo', 'æµè§ˆå™¨ä¸æ”¯æŒ HLS');
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾ï¼Œè¯·ä½¿ç”¨ Safari æˆ–æ”¯æŒ HLS.js çš„æµè§ˆå™¨');
                return;
            }

            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('hlsUrl').disabled = false;
        }

        function playStream() {
            try {
                const input = document.getElementById('hlsUrl').value.trim();
                if (!input) {
                    alert('è¯·è¾“å…¥ HLS URL æˆ– Session ID');
                    return;
                }

                const hlsUrl = normalizeHlsUrl(input);
                if (!hlsUrl) {
                    alert('æ— æ•ˆçš„ URL æˆ– Session ID');
                    return;
                }

                log(`å¼€å§‹æ’­æ”¾: ${hlsUrl}`, 'info');
                playStreamUrl(hlsUrl);

            } catch (error) {
                log(`âŒ æ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
                updateStatus('errorInfo', error.message);
                updateStatus('playbackState', 'æ’­æ”¾å¤±è´¥', false);
                document.getElementById('playBtn').disabled = false;
            }
        }

        function setupVideoEvents() {
            video.onloadedmetadata = () => {
                log('âœ… è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½', 'success');
                updateStatus('videoReady', 'æ˜¯');
                document.getElementById('placeholder').style.display = 'none';
            };

            video.oncanplay = () => {
                log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾', 'success');
                updateStatus('playbackState', 'æ­£åœ¨æ’­æ”¾', true);
            };

            video.onplay = () => {
                log('â–¶ï¸ å¼€å§‹æ’­æ”¾', 'success');
                updateStatus('playbackState', 'æ­£åœ¨æ’­æ”¾', true);
            };

            video.onpause = () => {
                log('â¸ï¸ å·²æš‚åœ', 'warning');
                updateStatus('playbackState', 'å·²æš‚åœ', false);
            };

            video.onended = () => {
                log('â¹ï¸ æ’­æ”¾ç»“æŸ', 'warning');
                updateStatus('playbackState', 'æ’­æ”¾ç»“æŸ', false);
            };

            video.onerror = (e) => {
                log(`âŒ è§†é¢‘æ’­æ”¾é”™è¯¯: ${video.error?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                updateStatus('errorInfo', video.error?.message || 'æœªçŸ¥é”™è¯¯');
                updateStatus('playbackState', 'æ’­æ”¾é”™è¯¯', false);
            };

            video.onwaiting = () => {
                log('â³ ç¼“å†²ä¸­...', 'warning');
                updateStatus('playbackState', 'ç¼“å†²ä¸­...', false);
            };

            video.onplaying = () => {
                log('â–¶ï¸ æ’­æ”¾ä¸­', 'success');
                updateStatus('playbackState', 'æ­£åœ¨æ’­æ”¾', true);
            };
        }

        function setupHlsEvents() {
            hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                log('âœ… HLS.js å·²é™„åŠ åˆ°è§†é¢‘å…ƒç´ ', 'success');
                updateStatus('hlsState', 'å·²é™„åŠ ');
            });

            hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                log(`âœ… æ¸…å•å·²è§£æï¼Œå…± ${data.levels.length} ä¸ªè´¨é‡çº§åˆ«`, 'success');
                updateStatus('hlsState', `æ¸…å•å·²è§£æ (${data.levels.length} ä¸ªçº§åˆ«)`);
                updateStatus('videoReady', 'æ˜¯');
                document.getElementById('placeholder').style.display = 'none';
                
                // å®æ—¶ç›´æ’­ï¼šç«‹å³è·³åˆ°æœ€æ–°ä½ç½®å¼€å§‹æ’­æ”¾
                if (hls.media) {
                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ¸…å•å®Œå…¨åŠ è½½
                    setTimeout(() => {
                        if (hls.liveSyncPosition !== null) {
                            // è·³åˆ°æœ€æ–°çš„åŒæ­¥ä½ç½®ï¼ˆå®æ—¶ç›´æ’­ä½ç½®ï¼‰
                            hls.media.currentTime = hls.liveSyncPosition;
                            log(`ğŸ¬ å·²è·³åˆ°å®æ—¶ç›´æ’­ä½ç½®: ${hls.liveSyncPosition.toFixed(2)}ç§’`, 'info');
                        } else if (hls.media.duration && isFinite(hls.media.duration)) {
                            // å¦‚æœæ— æ³•è·å–åŒæ­¥ä½ç½®ï¼Œè·³åˆ°æœ«å°¾ï¼ˆæ¥è¿‘å®æ—¶ï¼‰
                            hls.media.currentTime = hls.media.duration;
                            log(`ğŸ¬ å·²è·³åˆ°æœ«å°¾ä½ç½®ï¼ˆå®æ—¶ï¼‰: ${hls.media.duration.toFixed(2)}ç§’`, 'info');
                        }
                    }, 100);
                }
            });

            hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
                log(`ğŸ”„ åˆ‡æ¢åˆ°è´¨é‡çº§åˆ«: ${data.level}`, 'info');
            });

            hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                log(`ğŸ“¦ ç‰‡æ®µå·²åŠ è½½: ${data.frag.url}`, 'info');
            });

            hls.on(Hls.Events.FRAG_PARSED, () => {
                // ç‰‡æ®µè§£æå®Œæˆ
            });

            // å®æ—¶ç›´æ’­ï¼šå®šæœŸæ£€æŸ¥å¹¶è·³åˆ°æœ€æ–°ä½ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
            hls.on(Hls.Events.FRAG_CHANGED, (event, data) => {
                // ç‰‡æ®µåˆ‡æ¢æ—¶ï¼Œç¡®ä¿æ’­æ”¾ä½ç½®è·Ÿéšæœ€æ–°å†…å®¹
                if (hls.media && hls.liveSyncPosition !== null) {
                    const currentTime = hls.media.currentTime;
                    const liveSyncPos = hls.liveSyncPosition;
                    // å¦‚æœæ’­æ”¾ä½ç½®è½åå®æ—¶ä½ç½®è¶…è¿‡ 5 ç§’ï¼Œè‡ªåŠ¨è·³åˆ°æœ€æ–°ä½ç½®
                    if (liveSyncPos - currentTime > 5) {
                        hls.media.currentTime = liveSyncPos;
                        log(`ğŸ¬ è‡ªåŠ¨è·³åˆ°æœ€æ–°ä½ç½®: ${liveSyncPos.toFixed(2)}ç§’ (å»¶è¿Ÿ: ${(liveSyncPos - currentTime).toFixed(2)}ç§’)`, 'info');
                    }
                }
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    log(`âŒ HLS è‡´å‘½é”™è¯¯: ${data.type} - ${data.details}`, 'error');
                    updateStatus('errorInfo', `${data.type}: ${data.details}`);
                    updateStatus('hlsState', 'é”™è¯¯');
                    
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            log('ğŸ”„ å°è¯•æ¢å¤ç½‘ç»œé”™è¯¯...', 'warning');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            log('ğŸ”„ å°è¯•æ¢å¤åª’ä½“é”™è¯¯...', 'warning');
                            hls.recoverMediaError();
                            break;
                        default:
                            log('âŒ æ— æ³•æ¢å¤çš„é”™è¯¯', 'error');
                            stopStream();
                            break;
                    }
                } else {
                    log(`âš ï¸ HLS è­¦å‘Š: ${data.type} - ${data.details}`, 'warning');
                }
            });

            hls.on(Hls.Events.BUFFER_APPENDED, () => {
                // ç¼“å†²å·²è¿½åŠ 
            });

            setupVideoEvents();
        }

        async function stopStream() {
            if (hls) {
                hls.destroy();
                hls = null;
                log('å·²åœæ­¢ HLS æ’­æ”¾', 'warning');
            }

            video.pause();
            video.src = '';
            video.srcObject = null;

            document.getElementById('placeholder').style.display = 'block';

            updateStatus('currentUrl', '-');
            updateStatus('playbackState', 'æœªæ’­æ”¾', false);
            updateStatus('hlsState', '-');
            updateStatus('videoReady', '-');
            updateStatus('errorInfo', '-');

            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('hlsUrl').disabled = false;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('hostId').disabled = false;

              currentStreamUrl = null;
              currentSessionId = null; // æ¸…é™¤ sessionId
              
              // æ–­å¼€ SignalR è¿æ¥
              await disconnectControllerSignalR();
        }
        
        // è¿æ¥ SignalR æ§åˆ¶å™¨
        async function connectControllerSignalR(sessionId) {
            try {
                const token = getAuthToken();
                if (!token) {
                    log('âŒ æœªæ£€æµ‹åˆ° JWT Tokenï¼Œæ— æ³•å»ºç«‹ SignalR è¿æ¥', 'error');
                    return;
                }

                if (controllerConnection) {
                    await disconnectControllerSignalR();
                }
                
                log('ğŸ”Œ æ­£åœ¨è¿æ¥ SignalR æ§åˆ¶å™¨...', 'info');
                controllerConnection = new signalR.HubConnectionBuilder()
                    .withUrl('/hubs/controller', {
                        accessTokenFactory: () => getAuthToken() || ''
                    })
                    .build();
                
                // æ³¨å†Œäº‹ä»¶
                controllerConnection.on('ControllerConnected', (success) => {
                    log(`âœ… æ§åˆ¶å™¨å·²é€šè¿‡ SignalR è¿æ¥: ${success}`, 'success');
                    controllerConnected = true;
                });
                
                controllerConnection.on('ControllerStarted', (success) => {
                    log(`âœ… æ§åˆ¶å™¨å·²å¯åŠ¨: ${success}`, 'success');
                });
                
                controllerConnection.on('Error', (message) => {
                    log(`âŒ SignalR é”™è¯¯: ${message}`, 'error');
                });
                
                controllerConnection.onclose(() => {
                    log('âš ï¸ SignalR è¿æ¥å·²å…³é—­', 'warning');
                    controllerConnected = false;
                });
                
                await controllerConnection.start();
                log('âœ… SignalR è¿æ¥å·²å»ºç«‹', 'success');
                
                // è¿æ¥æ§åˆ¶å™¨åˆ°ä¼šè¯
                await controllerConnection.invoke('ConnectController', sessionId);
                
                // å¯åŠ¨æ§åˆ¶å™¨
                await controllerConnection.invoke('StartController', sessionId);
                
            } catch (error) {
                log(`âŒ SignalR è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                controllerConnection = null;
                controllerConnected = false;
            }
        }
        
        // æ–­å¼€ SignalR æ§åˆ¶å™¨
        async function disconnectControllerSignalR() {
            if (controllerConnection) {
                try {
                    if (currentSessionId) {
                        await controllerConnection.invoke('DisconnectController', currentSessionId);
                    }
                    await controllerConnection.stop();
                    log('âœ… SignalR è¿æ¥å·²æ–­å¼€', 'info');
                } catch (error) {
                    log(`âš ï¸ æ–­å¼€ SignalR è¿æ¥æ—¶å‡ºé”™: ${error.message}`, 'warning');
                }
                controllerConnection = null;
                controllerConnected = false;
            }
        }

        // æ§åˆ¶å™¨æŒ‰é’®å¤„ç†å‡½æ•°ï¼ˆä½¿ç”¨ SignalR ä½å»¶è¿Ÿï¼‰
        // action: 'press', 'release', 'tap'
        async function sendControllerButton(buttonName, action = 'tap') {
            // å¦‚æœ currentSessionId ä¸ºç©ºï¼Œå°è¯•ä»å½“å‰æµ URL ä¸­æå–
            if (!currentSessionId && currentStreamUrl) {
                const extractedSessionId = extractSessionIdFromUrl(currentStreamUrl);
                if (extractedSessionId) {
                    currentSessionId = extractedSessionId;
                    log(`âœ… ä»å½“å‰æµ URL ä¸­æå–ä¼šè¯ ID: ${extractedSessionId}`, 'success');
                }
            }
            
            if (!currentSessionId) {
                log('âŒ æ²¡æœ‰æ´»åŠ¨çš„ä¼šè¯ï¼Œæ— æ³•å‘é€æ§åˆ¶å™¨å‘½ä»¤', 'error');
                alert('è¯·å…ˆè¿æ¥å¹¶å¯åŠ¨æµ\n\nå¦‚æœå·²è¿æ¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–é‡æ–°è¿æ¥');
                return;
            }

            // å¦‚æœ SignalR æœªè¿æ¥ï¼Œå°è¯•è¿æ¥
            if (!controllerConnection || !controllerConnected) {
                log('âš ï¸ SignalR æœªè¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥...', 'warning');
                await connectControllerSignalR(currentSessionId);
                if (!controllerConnection || !controllerConnected) {
                    log('âŒ SignalR è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨ HTTP API ä½œä¸ºå¤‡ç”¨', 'error');
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ HTTP API
                    await sendControllerButtonHTTP(buttonName, action);
                    return;
                }
            }

            try {
                const startTime = performance.now();
                const delayMs = action === 'tap' ? 100 : 0;
                await controllerConnection.invoke('Button', currentSessionId, buttonName, action, delayMs);
                const endTime = performance.now();
                const latency = (endTime - startTime).toFixed(2);
                log(`âœ… æ§åˆ¶å™¨å‘½ä»¤å·²å‘é€ (SignalR): ${buttonName} [${action}] - å»¶è¿Ÿ: ${latency}ms`, 'success');
            } catch (error) {
                log(`âŒ SignalR å‘é€å¤±è´¥: ${error.message}ï¼Œå°è¯•ä½¿ç”¨ HTTP API`, 'error');
                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ HTTP API
                await sendControllerButtonHTTP(buttonName, action);
            }
        }
        
        // HTTP API å¤‡ç”¨æ–¹æ¡ˆ
        async function sendControllerButtonHTTP(buttonName, action = 'tap') {
            try {
                const response = await authorizedFetch('/api/PlayStation/controller/button', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        button: buttonName,
                        action: action,
                        delayMs: action === 'tap' ? 200 : 0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    log(`âœ… æ§åˆ¶å™¨å‘½ä»¤å·²å‘é€ (HTTP): ${buttonName} [${action}]`, 'success');
                } else {
                    log(`âš ï¸ æ§åˆ¶å™¨å‘½ä»¤å¤±è´¥: ${result.errorMessage || 'æœªçŸ¥é”™è¯¯'}`, 'warning');
                }
            } catch (error) {
                log(`âŒ HTTP API å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è·Ÿè¸ªå½“å‰æŒ‰ä¸‹çš„æŒ‰é’®ï¼ˆç”¨äºé•¿æŒ‰ï¼‰
        const pressedButtons = new Map(); // buttonName -> { pressTimer, releaseTimer }

        // åˆå§‹åŒ–æ§åˆ¶å™¨æŒ‰é’®äº‹ä»¶
        function initControllerButtons() {
            const controllerButtons = document.querySelectorAll('.controller-btn[data-button]');
            log(`åˆå§‹åŒ–æ§åˆ¶å™¨æŒ‰é’®: æ‰¾åˆ° ${controllerButtons.length} ä¸ªæŒ‰é’®`, 'info');
            
            if (controllerButtons.length === 0) {
                log(`âš ï¸ æœªæ‰¾åˆ°ä»»ä½•æ§åˆ¶å™¨æŒ‰é’®ï¼Œè¯·æ£€æŸ¥ HTML ç»“æ„`, 'warning');
                return;
            }
            
            controllerButtons.forEach((btn, index) => {
                const buttonName = btn.getAttribute('data-button');
                if (!buttonName) {
                    log(`âš ï¸ æŒ‰é’® ${index} æ²¡æœ‰ data-button å±æ€§`, 'warning');
                    return;
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆè½»æŒ‰ï¼Œå¿«é€ŸæŒ‰ä¸‹å¹¶é‡Šæ”¾ï¼‰
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    log(`ğŸ® ç‚¹å‡»æŒ‰é’®: ${buttonName}`, 'info');
                    sendControllerButton(buttonName, 'tap');
                    
                    // æ·»åŠ è§†è§‰åé¦ˆ
                    const originalTransform = btn.style.transform;
                    btn.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        btn.style.transform = originalTransform || '';
                    }, 100);
                }, false);
                
                // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼ˆé•¿æŒ‰å¼€å§‹ï¼‰
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.style.opacity = '0.7';
                    this.style.transform = 'scale(0.95)';
                    
                    // å¦‚æœå·²ç»åœ¨æŒ‰ä¸‹çŠ¶æ€ï¼Œå…ˆé‡Šæ”¾
                    if (pressedButtons.has(buttonName)) {
                        const existing = pressedButtons.get(buttonName);
                        if (existing.pressTimer) {
                            clearTimeout(existing.pressTimer);
                        }
                        if (existing.releaseTimer) {
                            clearTimeout(existing.releaseTimer);
                        }
                        // å…ˆå‘é€é‡Šæ”¾
                        sendControllerButton(buttonName, 'release');
                    }
                    
                    // å‘é€æŒ‰ä¸‹äº‹ä»¶
                    sendControllerButton(buttonName, 'press');
                    
                    // è®°å½•æŒ‰ä¸‹çŠ¶æ€
                    pressedButtons.set(buttonName, {
                        pressTimer: null,
                        releaseTimer: null,
                        button: this
                    });
                    
                    log(`ğŸ® æŒ‰é’®æŒ‰ä¸‹: ${buttonName} (é•¿æŒ‰æ¨¡å¼)`, 'info');
                }, false);
                
                // æ·»åŠ é¼ æ ‡é‡Šæ”¾äº‹ä»¶ï¼ˆé•¿æŒ‰ç»“æŸï¼‰
                btn.addEventListener('mouseup', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.style.opacity = '1';
                    this.style.transform = '';
                    
                    // å¦‚æœæŒ‰é’®åœ¨æŒ‰ä¸‹çŠ¶æ€ï¼Œå‘é€é‡Šæ”¾
                    if (pressedButtons.has(buttonName)) {
                        sendControllerButton(buttonName, 'release');
                        pressedButtons.delete(buttonName);
                        log(`ğŸ® æŒ‰é’®é‡Šæ”¾: ${buttonName}`, 'info');
                    }
                }, false);
                
                // é¼ æ ‡ç¦»å¼€æ—¶ä¹Ÿé‡Šæ”¾
                btn.addEventListener('mouseleave', function(e) {
                    this.style.opacity = '1';
                    this.style.transform = '';
                    
                    // å¦‚æœæŒ‰é’®åœ¨æŒ‰ä¸‹çŠ¶æ€ï¼Œå‘é€é‡Šæ”¾
                    if (pressedButtons.has(buttonName)) {
                        sendControllerButton(buttonName, 'release');
                        pressedButtons.delete(buttonName);
                        log(`ğŸ® æŒ‰é’®ç¦»å¼€é‡Šæ”¾: ${buttonName}`, 'info');
                    }
                }, false);
                
                // è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
                }, false);
                
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
                }, false);
                
                log(`âœ… å·²ç»‘å®šæŒ‰é’®: ${buttonName} (æ”¯æŒé•¿æŒ‰)`, 'info');
            });
            
            log(`âœ… æ§åˆ¶å™¨æŒ‰é’®åˆå§‹åŒ–å®Œæˆï¼Œå…±ç»‘å®š ${controllerButtons.length} ä¸ªæŒ‰é’®`, 'success');
        }

        function refreshStream() {
            if (!currentStreamUrl) {
                log('æ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„æµ', 'warning');
                return;
            }

            log('æ­£åœ¨åˆ·æ–°æµ...', 'info');
            const url = currentStreamUrl;
            stopStream();

            // çŸ­æš‚å»¶è¿Ÿåé‡æ–°æ’­æ”¾
            setTimeout(() => {
                document.getElementById('hlsUrl').value = url.includes('/hls/') 
                    ? url.split('/hls/')[1].split('/')[0] 
                    : url;
                playStream();
            }, 500);
        }

        // æ”¯æŒ Enter é”®æ’­æ”¾
        document.getElementById('hlsUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                playStream();
            }
        });

        // æ”¯æŒ Enter é”®è¿æ¥
        document.getElementById('hostId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectAndPlay();
            }
        });

        // é”®ç›˜æ˜ å°„é…ç½®
        const keyboardMapping = {
            // æ–¹å‘é”®
            'KeyW': 'UP',
            'ArrowUp': 'UP',
            'KeyS': 'DOWN',
            'ArrowDown': 'DOWN',
            'KeyA': 'LEFT',
            'ArrowLeft': 'LEFT',
            'KeyD': 'RIGHT',
            'ArrowRight': 'RIGHT',
            // ä¸»è¦æŒ‰é’®
            'Space': 'CROSS',      // ç©ºæ ¼ = âœ•
            'Enter': 'CIRCLE',     // Enter = â—‹ (ä½†éœ€è¦é˜²æ­¢åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘)
            'ShiftLeft': 'SQUARE', // å·¦ Shift = â–¡
            'ShiftRight': 'SQUARE',
            'ControlLeft': 'TRIANGLE', // å·¦ Ctrl = â–³
            'ControlRight': 'TRIANGLE',
            // è‚©é”®
            'KeyQ': 'L1',
            'KeyE': 'R1',
            'KeyZ': 'L2',
            'KeyC': 'R2',
            // åŠŸèƒ½é”®
            'Tab': 'OPTIONS',
            'Backspace': 'SHARE',
            'Escape': 'PS'
        };

        // å·²æŒ‰ä¸‹çš„é”®ï¼ˆç”¨äºé˜²æ­¢é‡å¤è§¦å‘ï¼‰
        const pressedKeys = new Set();

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyboardEvent(event, isKeyDown) {
            // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ–æ–‡æœ¬åŒºåŸŸï¼Œä¸å¤„ç†é”®ç›˜äº‹ä»¶ï¼ˆé™¤äº† Escapeï¼‰
            const activeElement = document.activeElement;
            const isInputFocused = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.isContentEditable
            );

            // Escape é”®å§‹ç»ˆå¤„ç†ï¼ˆç”¨äºé€€å‡ºè¾“å…¥æ¡†ï¼‰
            if (event.key === 'Escape' || event.code === 'Escape') {
                if (isInputFocused) {
                    activeElement.blur();
                }
                // ç»§ç»­å¤„ç† Escape é”®æ˜ å°„
            } else if (isInputFocused) {
                // å…¶ä»–é”®åœ¨è¾“å…¥æ¡†ä¸­æ—¶ä¸å¤„ç†
                return;
            }

            // é˜²æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæŸäº›é”®ï¼‰
            const keyCode = event.code || event.key;
            if (keyboardMapping[keyCode]) {
                // å¯¹äºæŸäº›é”®ï¼Œé˜²æ­¢é»˜è®¤è¡Œä¸º
                if (['Space', 'Tab', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(keyCode)) {
                    event.preventDefault();
                }
            }

            // å¤„ç†æŒ‰é”®
            const buttonName = keyboardMapping[keyCode];
            if (buttonName) {
                if (isKeyDown) {
                    // æŒ‰ä¸‹æ—¶åªè§¦å‘ä¸€æ¬¡ï¼ˆé˜²æ­¢é‡å¤ï¼‰
                    if (!pressedKeys.has(keyCode)) {
                        pressedKeys.add(keyCode);
                        
                        // é«˜äº®å¯¹åº”çš„æŒ‰é’®
                        const btn = document.querySelector(`.controller-btn[data-button="${buttonName}"]`);
                        if (btn) {
                            btn.style.opacity = '0.7';
                            btn.style.transform = 'scale(0.95)';
                        }
                        
                        // å‘é€æŒ‰ä¸‹äº‹ä»¶ï¼ˆé•¿æŒ‰æ¨¡å¼ï¼‰
                        log(`âŒ¨ï¸ é”®ç›˜æŒ‰ä¸‹: ${keyCode} -> ${buttonName} (é•¿æŒ‰æ¨¡å¼)`, 'info');
                        sendControllerButton(buttonName, 'press');
                    }
                } else {
                    // é‡Šæ”¾æ—¶ç§»é™¤æ ‡è®°
                    if (pressedKeys.has(keyCode)) {
                        pressedKeys.delete(keyCode);
                        
                        // æ¢å¤æŒ‰é’®æ ·å¼
                        const btn = document.querySelector(`.controller-btn[data-button="${buttonName}"]`);
                        if (btn) {
                            btn.style.opacity = '1';
                            btn.style.transform = '';
                        }
                        
                        // å‘é€é‡Šæ”¾äº‹ä»¶
                        log(`âŒ¨ï¸ é”®ç›˜é‡Šæ”¾: ${keyCode} -> ${buttonName}`, 'info');
                        sendControllerButton(buttonName, 'release');
                    }
                }
            }
        }

        // åˆå§‹åŒ–é”®ç›˜äº‹ä»¶ç›‘å¬
        function initKeyboardMapping() {
            // ç›‘å¬é”®ç›˜æŒ‰ä¸‹
            document.addEventListener('keydown', (event) => {
                handleKeyboardEvent(event, true);
            }, false);

            // ç›‘å¬é”®ç›˜é‡Šæ”¾
            document.addEventListener('keyup', (event) => {
                handleKeyboardEvent(event, false);
            }, false);

            // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶æ¸…é™¤æ‰€æœ‰æŒ‰é”®çŠ¶æ€
            window.addEventListener('blur', () => {
                // é‡Šæ”¾æ‰€æœ‰æŒ‰ä¸‹çš„æŒ‰é’®
                pressedKeys.forEach(keyCode => {
                    const buttonName = keyboardMapping[keyCode];
                    if (buttonName) {
                        sendControllerButton(buttonName, 'release');
                    }
                });
                pressedKeys.clear();
                
                // é‡Šæ”¾æ‰€æœ‰é¼ æ ‡æŒ‰ä¸‹çš„æŒ‰é’®
                pressedButtons.forEach((value, buttonName) => {
                    sendControllerButton(buttonName, 'release');
                });
                pressedButtons.clear();
                
                // æ¢å¤æ‰€æœ‰æŒ‰é’®æ ·å¼
                document.querySelectorAll('.controller-btn').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.transform = '';
                });
            });

            log('âœ… é”®ç›˜æ˜ å°„å·²åˆå§‹åŒ–', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateAuthTokenStatus();
            log('HLS Player å·²å°±ç»ª', 'success');
            log('è¯·è¾“å…¥ HLS URL æˆ– Session ID å¹¶ç‚¹å‡»æ’­æ”¾', 'info');
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (Hls.isSupported()) {
                log('âœ… HLS.js å·²åŠ è½½å¹¶æ”¯æŒ', 'success');
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                log('âœ… æµè§ˆå™¨åŸç”Ÿæ”¯æŒ HLS', 'success');
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾', 'error');
            }
            
            // åˆå§‹åŒ–æ§åˆ¶å™¨æŒ‰é’®
            initControllerButtons();
            
            // åˆå§‹åŒ–é”®ç›˜æ˜ å°„
            initKeyboardMapping();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            stopStream();
        });
    </script>
</body>
</html>


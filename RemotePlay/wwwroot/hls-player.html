<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayStation Remote Play - HLS Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        video {
            width: 100%;
            height: auto;
            display: block;
            min-height: 400px;
        }

        .video-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            text-align: center;
            font-size: 1.2em;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        input[type="text"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            height: 44px;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #11998e;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            min-width: 150px;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 44px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(235, 51, 73, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #666;
        }

        .status-value {
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .status-connected {
            color: #11998e;
            font-weight: 600;
        }

        .status-disconnected {
            color: #eb3349;
            font-weight: 600;
        }

        .logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info {
            color: #4fc3f7;
        }

        .log-success {
            color: #81c784;
        }

        .log-error {
            color: #e57373;
        }

        .log-warning {
            color: #ffb74d;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .url-input-group input[type="text"] {
            flex: 1;
        }

        .url-input-group button {
            flex-shrink: 0;
            white-space: nowrap;
        }

        .controller-section {
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .controller-wrapper {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .controller-shoulder-row {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .controller-center-space {
            flex: 1;
            min-width: 100px;
        }

        .controller-main-area {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .controller-left,
        .controller-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .controller-dpad-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controller-dpad {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .controller-dpad-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .controller-face-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .controller-face-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .controller-function-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .controller-btn {
            min-width: 60px;
            height: 60px;
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: 600;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controller-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border-color: #11998e;
        }

        .controller-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .controller-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .controller-btn-small {
            min-width: 80px;
            height: 44px;
            font-size: 0.9em;
            padding: 8px 15px;
        }

        .controller-btn-shoulder {
            min-width: 70px;
            height: 50px;
            font-size: 0.85em;
            padding: 8px 15px;
            background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
        }

        .controller-btn-dpad {
            min-width: 50px;
            height: 50px;
            font-size: 1.2em;
            padding: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .controller-btn-face {
            min-width: 70px;
            height: 70px;
            font-size: 1.5em;
            padding: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
        }

        .controller-btn-function {
            min-width: 90px;
            height: 40px;
            font-size: 0.75em;
            padding: 6px 12px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                gap: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                min-width: 100%;
                width: 100%;
            }

            .url-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .url-input-group input[type="text"] {
                width: 100%;
            }

            .url-input-group button {
                width: 100%;
            }

            .controller-btn {
                min-width: 50px;
                height: 50px;
                font-size: 1em;
            }

            .controller-btn-small {
                min-width: 70px;
                height: 40px;
                font-size: 0.8em;
            }

            .controller-main-area {
                flex-direction: column;
                gap: 20px;
            }

            .controller-shoulder-row {
                flex-wrap: wrap;
                justify-content: center;
            }

            .controller-center-space {
                display: none;
            }

            .controller-btn-shoulder {
                min-width: 60px;
                height: 45px;
                font-size: 0.75em;
            }

            .controller-btn-dpad {
                min-width: 45px;
                height: 45px;
                font-size: 1em;
            }

            .controller-btn-face {
                min-width: 60px;
                height: 60px;
                font-size: 1.2em;
            }

            .controller-btn-function {
                min-width: 80px;
                height: 38px;
                font-size: 0.7em;
            }
        }
    </style>
    <!-- HLS.js Â∫ìÁî®‰∫éÊí≠Êîæ HLS ÊµÅ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- SignalR Â∫ìÁî®‰∫é‰ΩéÂª∂ËøüÊéßÂà∂Âô®ËæìÂÖ• -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∫ PlayStation Remote Play</h1>
            <p>HLS ÊµÅÂ™í‰ΩìÊí≠ÊîæÂô®</p>
        </div>

        <div class="content">
            <div class="controller-section" id="authSection">
                <h3 style="margin-bottom: 15px; color: #333;">üîê Ë∫´‰ªΩÈ™åËØÅ</h3>
                <div class="input-group">
                    <label for="authTokenInput">JWT Token</label>
                    <div class="url-input-group">
                        <input type="password" id="authTokenInput" placeholder="Á≤òË¥¥ Bearer TokenÔºåÊàñÁõ¥Êé•ËæìÂÖ• JWT Â≠óÁ¨¶‰∏≤">
                        <button class="btn-primary" onclick="saveAuthToken()">‰øùÂ≠ò</button>
                        <button class="btn-danger" onclick="clearAuthToken()">Ê∏ÖÈô§</button>
                    </div>
                    <small id="authTokenStatus" style="color: #666; font-size: 0.85em;">
                        ÂΩìÂâçÊú™ÈÖçÁΩÆ Token„ÄÇ
                    </small>
                </div>
            </div>

            <div class="video-container">
                <video id="hlsVideo" controls autoplay playsinline></video>
                <div class="video-placeholder" id="placeholder">
                    Á≠âÂæÖÊí≠Êîæ...
                </div>
            </div>

            <div class="controller-section">
                <h3 style="margin-bottom: 15px; color: #333;">üéÆ PS5 ÊéßÂà∂Âô®</h3>
                <div style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 5px; font-size: 0.9em; color: #666;">
                    <strong>‚å®Ô∏è ÈîÆÁõòÊò†Â∞ÑÔºö</strong>
                    <span style="margin-left: 10px;">WASD/ÊñπÂêëÈîÆ = ÊñπÂêëÈîÆ</span>
                    <span style="margin-left: 10px;">Á©∫Ê†º = ‚úï</span>
                    <span style="margin-left: 10px;">Enter = ‚óã</span>
                    <span style="margin-left: 10px;">Shift = ‚ñ°</span>
                    <span style="margin-left: 10px;">Ctrl = ‚ñ≥</span>
                    <span style="margin-left: 10px;">Q = L1</span>
                    <span style="margin-left: 10px;">E = R1</span>
                    <span style="margin-left: 10px;">Z = L2</span>
                    <span style="margin-left: 10px;">C = R2</span>
                    <span style="margin-left: 10px;">Tab = OPTIONS</span>
                    <span style="margin-left: 10px;">Backspace = SHARE</span>
                    <span style="margin-left: 10px;">Esc = PS</span>
                </div>
                <div class="controller-wrapper">
                    <!-- ËÇ©ÈîÆÂå∫Âüü -->
                    <div class="controller-shoulder-row">
                        <button class="controller-btn controller-btn-shoulder" data-button="L1" title="L1">L1</button>
                        <button class="controller-btn controller-btn-shoulder" data-button="L2" title="L2">L2</button>
                        <div class="controller-center-space"></div>
                        <button class="controller-btn controller-btn-shoulder" data-button="R1" title="R1">R1</button>
                        <button class="controller-btn controller-btn-shoulder" data-button="R2" title="R2">R2</button>
                    </div>
                    
                    <!-- ‰∏ªË¶ÅÊéßÂà∂Âå∫Âüü -->
                    <div class="controller-main-area">
                        <!-- Â∑¶‰æßÔºöÊñπÂêëÈîÆ -->
                        <div class="controller-left">
                            <div class="controller-dpad-container">
                                <div class="controller-dpad">
                                    <button class="controller-btn controller-btn-dpad" data-button="UP" title="‰∏ä">‚Üë</button>
                                    <div class="controller-dpad-row">
                                        <button class="controller-btn controller-btn-dpad" data-button="LEFT" title="Â∑¶">‚Üê</button>
                                        <button class="controller-btn controller-btn-dpad" data-button="DOWN" title="‰∏ã">‚Üì</button>
                                        <button class="controller-btn controller-btn-dpad" data-button="RIGHT" title="Âè≥">‚Üí</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Âè≥‰æßÔºö‰∏ªË¶ÅÊåâÈíÆ -->
                        <div class="controller-right">
                            <div class="controller-face-buttons">
                                <button class="controller-btn controller-btn-face" data-button="TRIANGLE" title="‰∏âËßíÈîÆ">‚ñ≥</button>
                                <div class="controller-face-row">
                                    <button class="controller-btn controller-btn-face" data-button="SQUARE" title="ÊñπÂùóÈîÆ">‚ñ°</button>
                                    <button class="controller-btn controller-btn-face" data-button="CROSS" title="ÂèâÈîÆ">‚úï</button>
                                    <button class="controller-btn controller-btn-face" data-button="CIRCLE" title="ÂúÜÂúàÈîÆ">‚óã</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂäüËÉΩÈîÆÂå∫Âüü -->
                    <div class="controller-function-row">
                        <button class="controller-btn controller-btn-function" data-button="OPTIONS" title="ÈÄâÈ°π">OPTIONS</button>
                        <button class="controller-btn controller-btn-function" data-button="SHARE" title="ÂàÜ‰∫´">SHARE</button>
                        <button class="controller-btn controller-btn-function" data-button="PS" title="PS ÈîÆ">PS</button>
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="input-group">
                    <label for="hostId">‰∏ªÊú∫ ID (Host ID)</label>
                    <div class="url-input-group">
                        <input type="text" id="hostId" placeholder="ËæìÂÖ•‰∏ªÊú∫ IDÔºåÂ∞ÜËá™Âä®ÂêØÂä® HLS ÊµÅ">
                        <button class="btn-primary" id="connectBtn" onclick="connectAndPlay()">
                            üîå ËøûÊé•Âπ∂Êí≠Êîæ
                        </button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="hlsUrl">ÊàñÁõ¥Êé•ËæìÂÖ• HLS ÊµÅÂú∞ÂùÄ (ÂÆåÊï¥ URL Êàñ Session ID)</label>
                    <div class="url-input-group">
                        <input type="text" id="hlsUrl" placeholder="ËæìÂÖ• HLS URL Êàñ Session ID">
                        <button class="btn-primary" id="playBtn" onclick="playStream()">
                            ‚ñ∂Ô∏è Êí≠Êîæ
                        </button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-danger" id="stopBtn" onclick="stopStream()" disabled>
                    ‚èπÔ∏è ÂÅúÊ≠¢
                </button>
                <button class="btn-success" id="refreshBtn" onclick="refreshStream()" disabled>
                    üîÑ Âà∑Êñ∞
                </button>
            </div>

            <div class="status">
                <h3 style="margin-bottom: 15px; color: #333;">üìä Êí≠ÊîæÁä∂ÊÄÅ</h3>
                <div class="status-item">
                    <span class="status-label">ÂΩìÂâçÊµÅÂú∞ÂùÄ:</span>
                    <span class="status-value" id="currentUrl">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Êí≠ÊîæÁä∂ÊÄÅ:</span>
                    <span class="status-value status-disconnected" id="playbackState">Êú™Êí≠Êîæ</span>
                </div>
                <div class="status-item">
                    <span class="status-label">HLS.js Áä∂ÊÄÅ:</span>
                    <span class="status-value" id="hlsState">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ËßÜÈ¢ëÂ∞±Áª™:</span>
                    <span class="status-value" id="videoReady">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ÈîôËØØ‰ø°ÊÅØ:</span>
                    <span class="status-value" id="errorInfo">-</span>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom: 15px; color: #333;">üìù Êó•Âøó</h3>
                <div class="logs" id="logs"></div>
            </div>
        </div>
    </div>

    <script>
        const AUTH_STORAGE_KEY = 'remoteplay.authToken';
        let authToken = localStorage.getItem(AUTH_STORAGE_KEY) || '';
        let warnedAuthMissing = false;

        function getAuthToken() {
            return authToken?.trim() || '';
        }

        function setAuthToken(token) {
            authToken = (token || '').trim();
            if (authToken) {
                localStorage.setItem(AUTH_STORAGE_KEY, authToken);
            } else {
                localStorage.removeItem(AUTH_STORAGE_KEY);
            }
            warnedAuthMissing = false;
            updateAuthTokenStatus();
        }

        function updateAuthTokenStatus() {
            const statusEl = document.getElementById('authTokenStatus');
            const inputEl = document.getElementById('authTokenInput');
            if (!statusEl || !inputEl) {
                return;
            }
            if (authToken) {
                statusEl.textContent = `Token Â∑≤‰øùÂ≠òÔºàÈïøÂ∫¶ ${authToken.length}Ôºâ`;
                statusEl.style.color = '#11998e';
                inputEl.value = authToken;
            } else {
                statusEl.textContent = 'ÂΩìÂâçÊú™ÈÖçÁΩÆ Token„ÄÇ';
                statusEl.style.color = '#666';
                inputEl.value = '';
            }
        }

        function saveAuthToken() {
            const input = document.getElementById('authTokenInput');
            setAuthToken(input?.value || '');
            if (authToken) {
                log('‚úÖ Token Â∑≤‰øùÂ≠ò', 'success');
            } else {
                log('‚úÖ Token Â∑≤Ê∏ÖÁ©∫', 'info');
            }
        }

        function clearAuthToken() {
            setAuthToken('');
            log('‚úÖ Token Â∑≤Ê∏ÖÁ©∫', 'info');
        }

        function authorizedFetch(url, options = {}) {
            const headers = new Headers(options.headers || {});
            const token = getAuthToken();
            if (token) {
                headers.set('Authorization', `Bearer ${token}`);
                warnedAuthMissing = false;
            } else if (!warnedAuthMissing) {
                log('‚ö†Ô∏è Â∞öÊú™ËÆæÁΩÆ JWT TokenÔºåËØ∑Âú®‚ÄúË∫´‰ªΩÈ™åËØÅ‚Äù‰∏≠ÈÖçÁΩÆ', 'warning');
                warnedAuthMissing = true;
            }
            return fetch(url, { ...options, headers });
        }

        const KEYFRAME_REFRESH_INTERVAL_MS = 10000; // 10 ÁßíÂà∑Êñ∞‰∏ÄÊ¨°ÂÖ≥ÈîÆÂ∏ß
        let keyframeRefreshTimer = null;

        function stopKeyframeRefresh() {
            if (keyframeRefreshTimer) {
                clearInterval(keyframeRefreshTimer);
                keyframeRefreshTimer = null;
            }
        }

        function startKeyframeRefresh(sessionId) {
            stopKeyframeRefresh();
            if (!sessionId) {
                return;
            }

            keyframeRefreshTimer = setInterval(() => {
                requestKeyframe(sessionId, { silent: true });
            }, KEYFRAME_REFRESH_INTERVAL_MS);
        }

        // ‰∏ªÂä®ËØ∑Ê±ÇÂÖ≥ÈîÆÂ∏ßÔºàÈÄÇÁî®‰∫é HLS/RemotePlay ‰ºöËØùÔºâ
        async function requestKeyframe(sessionId, options = {}) {
            if (!sessionId) {
                return;
            }

            const { silent = false } = options;

            try {
                if (!silent) {
                    log(`üéØ ËØ∑Ê±ÇÂÖ≥ÈîÆÂ∏ß: ${sessionId}`, 'info');
                }
                const response = await authorizedFetch(`/api/Streaming/session/${sessionId}/keyframe`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå ËØ∑Ê±ÇÂÖ≥ÈîÆÂ∏ßÂ§±Ë¥•: ${response.status} ${errorText}`, 'error');
                    return;
                }

                const result = await response.json().catch(() => null);
                if (result?.success) {
                    if (!silent) {
                        log('‚úÖ ÂÖ≥ÈîÆÂ∏ßËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ', 'success');
                    }
                } else {
                    const message = result?.errorMessage || result?.message || 'Êú™Áü•ÈîôËØØ';
                    log(`‚ö†Ô∏è ÂÖ≥ÈîÆÂ∏ßËØ∑Ê±ÇËøîÂõûÈùûÊàêÂäüÁä∂ÊÄÅ: ${message}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå ËØ∑Ê±ÇÂÖ≥ÈîÆÂ∏ßÂá∫Áé∞ÂºÇÂ∏∏: ${error.message}`, 'error');
            }
        }

        let hls = null;
        let currentStreamUrl = null;
        let currentSessionId = null; // ÂΩìÂâç‰ºöËØù IDÔºåÁî®‰∫éÊéßÂà∂Âô®
        const video = document.getElementById('hlsVideo');
        
        // SignalR ËøûÊé•ÔºàÁî®‰∫é‰ΩéÂª∂ËøüÊéßÂà∂Âô®ËæìÂÖ•Ôºâ
        let controllerConnection = null;
        let controllerConnected = false;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(field, value, isConnected = null) {
            const element = document.getElementById(field);
            if (element) {
                element.textContent = value || '-';
                if (isConnected !== null && field === 'playbackState') {
                    element.className = isConnected ? 'status-value status-connected' : 'status-value status-disconnected';
                }
            }
        }

        function normalizeHlsUrl(input) {
            if (!input || !input.trim()) {
                return null;
            }

            const trimmed = input.trim();

            // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂÆåÊï¥ÁöÑ URLÔºåÁõ¥Êé•ËøîÂõû
            if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {
                return trimmed;
            }

            // Â¶ÇÊûúÊòØ Session IDÔºåÊûÑÂª∫ÂÆåÊï¥ÁöÑ HLS URL
            const baseUrl = window.location.origin;
            return `${baseUrl}/hls/${trimmed}/index.m3u8`;
        }

        async function connectAndPlay() {
            try {
                const hostId = document.getElementById('hostId').value.trim();
                if (!hostId) {
                    alert('ËØ∑ËæìÂÖ•‰∏ªÊú∫ ID');
                    return;
                }

                log(`ÂºÄÂßãËøûÊé•‰∏ªÊú∫: ${hostId}...`, 'info');
                updateStatus('playbackState', 'ËøûÊé•‰∏≠...', false);
                updateStatus('errorInfo', '-');

                // Á¶ÅÁî®ÊåâÈíÆ
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('hostId').disabled = true;

                // 1. ÂêØÂä®‰ºöËØù
                log('Ê≠£Âú®ÂêØÂä®‰ºöËØù...', 'info');
                const startSessionResponse = await authorizedFetch(`/api/PlayStation/start-session?hostId=${encodeURIComponent(hostId)}`, {
                    method: 'POST'
                });

                if (!startSessionResponse.ok) {
                    throw new Error(`ÂêØÂä®‰ºöËØùÂ§±Ë¥•: ${startSessionResponse.statusText}`);
                }

                const startSessionResult = await startSessionResponse.json();
                if (!startSessionResult.success) {
                    throw new Error(`ÂêØÂä®‰ºöËØùÂ§±Ë¥•: ${startSessionResult.errorMessage || 'Êú™Áü•ÈîôËØØ'}`);
                }

                const sessionId = startSessionResult.data?.id;
                if (!sessionId) {
                    throw new Error('‰ºöËØùÂêØÂä®ÊàêÂäüÔºå‰ΩÜÊú™ËøîÂõû‰ºöËØù ID');
                }

                log(`‚úÖ ‰ºöËØùÂêØÂä®ÊàêÂäü: ${sessionId}`, 'success');
                updateStatus('currentUrl', `Session: ${sessionId}`);
                
                // ‰øùÂ≠ò sessionId Áî®‰∫éÊéßÂà∂Âô®
                currentSessionId = sessionId;
                
                // ËøûÊé• SignalR ÊéßÂà∂Âô®Ôºà‰ΩéÂª∂ËøüÔºâ
                await connectControllerSignalR(sessionId);

                // 2. Á≠âÂæÖÊµÅÂêØÂä®Ôºà‰ºöËØùÂèØËÉΩÂ∑≤Ëá™Âä®ÂêØÂä®ÊµÅÔºå‰ΩÜÈúÄË¶ÅÁ≠âÂæÖ‰∏Ä‰∏ãÔºâ
                log('Á≠âÂæÖÊµÅÂêØÂä®...', 'info');
                await new Promise(resolve => setTimeout(resolve, 2000)); // Á≠âÂæÖ 5 Áßí

                // 3. Á°Æ‰øùÊµÅÂ∑≤ÂêØÂä®
              /*  log('Ê£ÄÊü•ÊµÅÁä∂ÊÄÅ...', 'info');
                const startStreamResponse = await authorizedFetch(`/api/PlayStation/start-stream?sessionId=${sessionId}&test=false`, {
                    method: 'POST'
                });
                
                if (startStreamResponse.ok) {
                    const startStreamResult = await startStreamResponse.json();
                    if (startStreamResult.success) {
                        log('‚úÖ ÊµÅÂ∑≤ÂêØÂä®', 'success');
                        // ÂÜçÁ≠âÂæÖ‰∏Ä‰∏ãÔºåËÆ©ÊµÅÁ®≥ÂÆö
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        log('‚ö†Ô∏è ÊµÅÂêØÂä®ÂèØËÉΩÂ§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØï...', 'warning');
                    }
                }*/

                // 4. ÂêØÂä® HLS ÊµÅ
                log('Ê≠£Âú®ÂêØÂä® HLS ÊµÅ...', 'info');
                const shareHlsParams = new URLSearchParams({
                    sessionId: sessionId,
                    segmentTime: '1', 
                    listSize: '6',
                    enableAudio: 'false',
                    useTcp: 'true',
                    enableVideo: 'true'
                });
                const shareHlsResponse = await authorizedFetch(`/api/PlayStation/share-hls?${shareHlsParams.toString()}`, {
                    method: 'POST'
                });

                if (!shareHlsResponse.ok) {
                    throw new Error(`ÂêØÂä® HLS ÊµÅÂ§±Ë¥•: ${shareHlsResponse.statusText}`);
                }

                const shareHlsResult = await shareHlsResponse.json();
                if (!shareHlsResult.success) {
                    const errorMsg = shareHlsResult.errorMessage || 'Êú™Áü•ÈîôËØØ';
                    log(`‚ö†Ô∏è È¶ñÊ¨°Â∞ùËØïÂêØÂä® HLS ÊµÅÂ§±Ë¥•: ${errorMsg}`, 'warning');
                    
                    // Â¶ÇÊûúÂ§±Ë¥•ÔºåÁ≠âÂæÖ 3 ÁßíÂêéÈáçËØï‰∏ÄÊ¨°
                    log('Á≠âÂæÖ 3 ÁßíÂêéÈáçËØï...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const retryResponse = await authorizedFetch(`/api/PlayStation/share-hls?${shareHlsParams.toString()}`, {
                        method: 'POST'
                    });
                    
                    if (!retryResponse.ok) {
                        throw new Error(`ÂêØÂä® HLS ÊµÅÂ§±Ë¥•: ${retryResponse.statusText}`);
                    }
                    
                    const retryResult = await retryResponse.json();
                    if (!retryResult.success) {
                        const retryErrorMsg = retryResult.errorMessage || 'Êú™Áü•ÈîôËØØ';
                        throw new Error(`ÂêØÂä® HLS ÊµÅÂ§±Ë¥•ÔºàÈáçËØïÂêéÔºâ: ${retryErrorMsg}`);
                    }
                    
                    // ‰ΩøÁî®ÈáçËØïÁªìÊûú
                    const retryHlsUrl = retryResult.data?.url;
                    if (!retryHlsUrl) {
                        const baseUrl = window.location.origin;
                        const constructedUrl = `${baseUrl}/hls/${sessionId.replace(/-/g, '')}/index.m3u8`;
                        log(`‚úÖ HLS ÊµÅÂêØÂä®ÊàêÂäüÔºàÈáçËØïÔºâÔºå‰ΩøÁî®ÊûÑÂª∫ÁöÑ URL: ${constructedUrl}`, 'success');
                        document.getElementById('hlsUrl').value = sessionId.replace(/-/g, '');
                        await playStreamUrl(constructedUrl);
                        return;
                    } else {
                        log(`‚úÖ HLS ÊµÅÂêØÂä®ÊàêÂäüÔºàÈáçËØïÔºâ: ${retryHlsUrl}`, 'success');
                        document.getElementById('hlsUrl').value = retryHlsUrl;
                        await playStreamUrl(retryHlsUrl);
                        return;
                    }
                }

                const hlsUrl = shareHlsResult.data?.url;
                if (!hlsUrl) {
                    // Â¶ÇÊûúÊ≤°ÊúâËøîÂõû URLÔºåÊ†πÊçÆ sessionId ÊûÑÂª∫ URL
                    const baseUrl = window.location.origin;
                    const constructedUrl = `${baseUrl}/hls/${sessionId.replace(/-/g, '')}/index.m3u8`;
                    log(`‚úÖ HLS ÊµÅÂêØÂä®ÊàêÂäüÔºå‰ΩøÁî®ÊûÑÂª∫ÁöÑ URL: ${constructedUrl}`, 'success');
                    
                    // ËÆæÁΩÆ URL Âπ∂ÂºÄÂßãÊí≠Êîæ
                    document.getElementById('hlsUrl').value = sessionId.replace(/-/g, '');
                    await playStreamUrl(constructedUrl);
                } else {
                    log(`‚úÖ HLS ÊµÅÂêØÂä®ÊàêÂäü: ${hlsUrl}`, 'success');
                    
                    // ËÆæÁΩÆ URL Âπ∂ÂºÄÂßãÊí≠Êîæ
                    document.getElementById('hlsUrl').value = hlsUrl;
                    await playStreamUrl(hlsUrl);
                }

            } catch (error) {
                log(`‚ùå ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
                updateStatus('errorInfo', error.message);
                updateStatus('playbackState', 'ËøûÊé•Â§±Ë¥•', false);
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('hostId').disabled = false;
            }
        }

        // ‰ªé HLS URL ‰∏≠ÊèêÂèñ sessionIdÔºàËøîÂõû GUID Ê†ºÂºèÔºâ
        function extractSessionIdFromUrl(url) {
            if (!url) return null;
            
            // ÂÖàÂ∞ùËØïÂåπÈÖç GUID Ê†ºÂºèÔºàÂ∏¶ËøûÂ≠óÁ¨¶Ôºâ
            // Ê†ºÂºè: /hls/{guid-format}/index.m3u8 Êàñ /hls/{guid-format}
            const guidMatch = url.match(/\/hls\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})(?:\/|$)/i);
            if (guidMatch && guidMatch[1]) {
                return guidMatch[1].toLowerCase(); // ËøîÂõûÊ†áÂáÜ GUID Ê†ºÂºèÔºàÂ∞èÂÜôÔºâ
            }
            
            // Â¶ÇÊûú URL ‰∏≠ÁöÑ sessionId ÊòØ32‰ΩçÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶‰∏≤ÔºàÊó†ËøûÂ≠óÁ¨¶ÔºâÔºåËΩ¨Êç¢‰∏∫ GUID Ê†ºÂºè
            // Ê†ºÂºè: /hls/{32-hex-characters}/index.m3u8 Êàñ /hls/{32-hex-characters}
            const hexMatch = url.match(/\/hls\/([a-f0-9]{32})(?:\/|$)/i);
            if (hexMatch && hexMatch[1]) {
                const hex = hexMatch[1].toLowerCase();
                // Â∞Ü32‰ΩçÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫ GUID Ê†ºÂºè: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
                return `${hex.substring(0, 8)}-${hex.substring(8, 12)}-${hex.substring(12, 16)}-${hex.substring(16, 20)}-${hex.substring(20, 32)}`;
            }
            
            return null;
        }

        async function playStreamUrl(hlsUrl) {
            // Â∞ùËØï‰ªé URL ‰∏≠ÊèêÂèñ sessionIdÔºàÂú®ÂÅúÊ≠¢‰πãÂâç‰øùÂ≠òÔºâ
            const extractedSessionId = extractSessionIdFromUrl(hlsUrl);
            
            // Ë∞ÉÁî®Áé∞ÊúâÁöÑÊí≠ÊîæÈÄªËæë
            currentStreamUrl = hlsUrl;
            updateStatus('currentUrl', hlsUrl);
            updateStatus('playbackState', 'ËøûÊé•‰∏≠...', false);
            updateStatus('hlsState', 'ÂàùÂßãÂåñ‰∏≠...');
            updateStatus('errorInfo', '-');

            // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÔºàËøô‰ºöÊ∏ÖÈô§ sessionIdÔºåÊâÄ‰ª•ÈúÄË¶ÅÂú®‰πãÂêéÈáçÊñ∞ËÆæÁΩÆÔºâ
            const savedSessionId = currentSessionId; // ‰øùÂ≠òÂΩìÂâçÁöÑ sessionId
            stopStream();
            
            // ÊÅ¢Â§çÊàñËÆæÁΩÆ sessionId
            if (extractedSessionId) {
                currentSessionId = extractedSessionId;
                log(`‚úÖ ‰ªé URL ‰∏≠ÊèêÂèñ‰ºöËØù ID: ${extractedSessionId}`, 'success');
                // ËøûÊé• SignalR ÊéßÂà∂Âô®ÔºàÂ¶ÇÊûú‰ªé URL ÊèêÂèñÂà∞ sessionIdÔºâ
                await connectControllerSignalR(extractedSessionId);
                await requestKeyframe(extractedSessionId);
                startKeyframeRefresh(extractedSessionId);
            } else if (savedSessionId) {
                currentSessionId = savedSessionId; // ÊÅ¢Â§ç‰πãÂâç‰øùÂ≠òÁöÑ sessionId
                // ËøûÊé• SignalR ÊéßÂà∂Âô®
                await connectControllerSignalR(savedSessionId);
                await requestKeyframe(savedSessionId);
                startKeyframeRefresh(savedSessionId);
            }

            // Âº∫Âà∂‰ΩøÁî® HLS.js
            if (Hls.isSupported()) {
                log('‚úÖ ‰ΩøÁî® HLS.js Êí≠Êîæ', 'info');
                
                // Â¶ÇÊûúÂ∑≤Êúâ HLS ÂÆû‰æãÔºåÂÖàÈîÄÊØÅ
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    maxBufferSize: 60 * 1000 * 1000,
                    maxBufferHole: 0.5,
                    startLevel: -1,
                    capLevelToPlayerSize: true,
                    debug: true,
                    // ÂÆûÊó∂Áõ¥Êí≠ÈÖçÁΩÆÔºö‰ªéÊúÄÊñ∞‰ΩçÁΩÆÂºÄÂßãÊí≠ÊîæÔºà‰ΩøÁî®Âü∫‰∫éÁâáÊÆµÊï∞ÈáèÁöÑÈÖçÁΩÆÔºâ
                    liveSyncDurationCount: 3, // ‰øùÊåÅ 3 ‰∏™ÁâáÊÆµÁöÑÂª∂ËøüÔºàÊõ¥Êé•ËøëÂÆûÊó∂Ôºâ
                    liveMaxLatencyDurationCount: Infinity, // ÂÖÅËÆ∏Êó†ÈôêÂª∂ËøüÔºàÊÄªÊòØË∑üÈöèÊúÄÊñ∞ÂÜÖÂÆπÔºâ
                    xhrSetup: function(xhr, url) {
                        xhr.withCredentials = false;
                    }
                });

                hls.loadSource(hlsUrl);
                hls.attachMedia(video);

                setupHlsEvents();
            } else {
                log('‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅ HLS Êí≠Êîæ', 'error');
                updateStatus('errorInfo', 'ÊµèËßàÂô®‰∏çÊîØÊåÅ HLS');
                alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅ HLS Êí≠ÊîæÔºåËØ∑‰ΩøÁî® Safari ÊàñÊîØÊåÅ HLS.js ÁöÑÊµèËßàÂô®');
                return;
            }

            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('hlsUrl').disabled = false;
        }

        function playStream() {
            try {
                const input = document.getElementById('hlsUrl').value.trim();
                if (!input) {
                    alert('ËØ∑ËæìÂÖ• HLS URL Êàñ Session ID');
                    return;
                }

                const hlsUrl = normalizeHlsUrl(input);
                if (!hlsUrl) {
                    alert('Êó†ÊïàÁöÑ URL Êàñ Session ID');
                    return;
                }

                log(`ÂºÄÂßãÊí≠Êîæ: ${hlsUrl}`, 'info');
                playStreamUrl(hlsUrl);

            } catch (error) {
                log(`‚ùå Êí≠ÊîæÂ§±Ë¥•: ${error.message}`, 'error');
                updateStatus('errorInfo', error.message);
                updateStatus('playbackState', 'Êí≠ÊîæÂ§±Ë¥•', false);
                document.getElementById('playBtn').disabled = false;
            }
        }

        function setupVideoEvents() {
            video.onloadedmetadata = () => {
                log('‚úÖ ËßÜÈ¢ëÂÖÉÊï∞ÊçÆÂ∑≤Âä†ËΩΩ', 'success');
                updateStatus('videoReady', 'ÊòØ');
                document.getElementById('placeholder').style.display = 'none';
            };

            video.oncanplay = () => {
                log('‚úÖ ËßÜÈ¢ëÂèØ‰ª•Êí≠Êîæ', 'success');
                updateStatus('playbackState', 'Ê≠£Âú®Êí≠Êîæ', true);
            };

            video.onplay = () => {
                log('‚ñ∂Ô∏è ÂºÄÂßãÊí≠Êîæ', 'success');
                updateStatus('playbackState', 'Ê≠£Âú®Êí≠Êîæ', true);
            };

            video.onpause = () => {
                log('‚è∏Ô∏è Â∑≤ÊöÇÂÅú', 'warning');
                updateStatus('playbackState', 'Â∑≤ÊöÇÂÅú', false);
            };

            video.onended = () => {
                log('‚èπÔ∏è Êí≠ÊîæÁªìÊùü', 'warning');
                updateStatus('playbackState', 'Êí≠ÊîæÁªìÊùü', false);
            };

            video.onerror = (e) => {
                log(`‚ùå ËßÜÈ¢ëÊí≠ÊîæÈîôËØØ: ${video.error?.message || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                updateStatus('errorInfo', video.error?.message || 'Êú™Áü•ÈîôËØØ');
                updateStatus('playbackState', 'Êí≠ÊîæÈîôËØØ', false);
            };

            video.onwaiting = () => {
                log('‚è≥ ÁºìÂÜ≤‰∏≠...', 'warning');
                updateStatus('playbackState', 'ÁºìÂÜ≤‰∏≠...', false);
            };

            video.onplaying = () => {
                log('‚ñ∂Ô∏è Êí≠Êîæ‰∏≠', 'success');
                updateStatus('playbackState', 'Ê≠£Âú®Êí≠Êîæ', true);
            };
        }

        function setupHlsEvents() {
            hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                log('‚úÖ HLS.js Â∑≤ÈôÑÂä†Âà∞ËßÜÈ¢ëÂÖÉÁ¥†', 'success');
                updateStatus('hlsState', 'Â∑≤ÈôÑÂä†');
            });

            hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                log(`‚úÖ Ê∏ÖÂçïÂ∑≤Ëß£ÊûêÔºåÂÖ± ${data.levels.length} ‰∏™Ë¥®ÈáèÁ∫ßÂà´`, 'success');
                updateStatus('hlsState', `Ê∏ÖÂçïÂ∑≤Ëß£Êûê (${data.levels.length} ‰∏™Á∫ßÂà´)`);
                updateStatus('videoReady', 'ÊòØ');
                document.getElementById('placeholder').style.display = 'none';
                
                // ÂÆûÊó∂Áõ¥Êí≠ÔºöÁ´ãÂç≥Ë∑≥Âà∞ÊúÄÊñ∞‰ΩçÁΩÆÂºÄÂßãÊí≠Êîæ
                if (hls.media) {
                    // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥Á°Æ‰øùÊ∏ÖÂçïÂÆåÂÖ®Âä†ËΩΩ
                    setTimeout(() => {
                        if (hls.liveSyncPosition !== null) {
                            // Ë∑≥Âà∞ÊúÄÊñ∞ÁöÑÂêåÊ≠•‰ΩçÁΩÆÔºàÂÆûÊó∂Áõ¥Êí≠‰ΩçÁΩÆÔºâ
                            hls.media.currentTime = hls.liveSyncPosition;
                            log(`üé¨ Â∑≤Ë∑≥Âà∞ÂÆûÊó∂Áõ¥Êí≠‰ΩçÁΩÆ: ${hls.liveSyncPosition.toFixed(2)}Áßí`, 'info');
                        } else if (hls.media.duration && isFinite(hls.media.duration)) {
                            // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñÂêåÊ≠•‰ΩçÁΩÆÔºåË∑≥Âà∞Êú´Â∞æÔºàÊé•ËøëÂÆûÊó∂Ôºâ
                            hls.media.currentTime = hls.media.duration;
                            log(`üé¨ Â∑≤Ë∑≥Âà∞Êú´Â∞æ‰ΩçÁΩÆÔºàÂÆûÊó∂Ôºâ: ${hls.media.duration.toFixed(2)}Áßí`, 'info');
                        }
                    }, 100);
                }
            });

            hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
                log(`üîÑ ÂàáÊç¢Âà∞Ë¥®ÈáèÁ∫ßÂà´: ${data.level}`, 'info');
            });

            hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                log(`üì¶ ÁâáÊÆµÂ∑≤Âä†ËΩΩ: ${data.frag.url}`, 'info');
            });

            hls.on(Hls.Events.FRAG_PARSED, () => {
                // ÁâáÊÆµËß£ÊûêÂÆåÊàê
            });

            // ÂÆûÊó∂Áõ¥Êí≠ÔºöÂÆöÊúüÊ£ÄÊü•Âπ∂Ë∑≥Âà∞ÊúÄÊñ∞‰ΩçÁΩÆÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
            hls.on(Hls.Events.FRAG_CHANGED, (event, data) => {
                // ÁâáÊÆµÂàáÊç¢Êó∂ÔºåÁ°Æ‰øùÊí≠Êîæ‰ΩçÁΩÆË∑üÈöèÊúÄÊñ∞ÂÜÖÂÆπ
                if (hls.media && hls.liveSyncPosition !== null) {
                    const currentTime = hls.media.currentTime;
                    const liveSyncPos = hls.liveSyncPosition;
                    // Â¶ÇÊûúÊí≠Êîæ‰ΩçÁΩÆËêΩÂêéÂÆûÊó∂‰ΩçÁΩÆË∂ÖËøá 5 ÁßíÔºåËá™Âä®Ë∑≥Âà∞ÊúÄÊñ∞‰ΩçÁΩÆ
                    if (liveSyncPos - currentTime > 5) {
                        hls.media.currentTime = liveSyncPos;
                        log(`üé¨ Ëá™Âä®Ë∑≥Âà∞ÊúÄÊñ∞‰ΩçÁΩÆ: ${liveSyncPos.toFixed(2)}Áßí (Âª∂Ëøü: ${(liveSyncPos - currentTime).toFixed(2)}Áßí)`, 'info');
                    }
                }
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    log(`‚ùå HLS Ëá¥ÂëΩÈîôËØØ: ${data.type} - ${data.details}`, 'error');
                    updateStatus('errorInfo', `${data.type}: ${data.details}`);
                    updateStatus('hlsState', 'ÈîôËØØ');
                    
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            log('üîÑ Â∞ùËØïÊÅ¢Â§çÁΩëÁªúÈîôËØØ...', 'warning');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            log('üîÑ Â∞ùËØïÊÅ¢Â§çÂ™í‰ΩìÈîôËØØ...', 'warning');
                            hls.recoverMediaError();
                            break;
                        default:
                            log('‚ùå Êó†Ê≥ïÊÅ¢Â§çÁöÑÈîôËØØ', 'error');
                            stopStream();
                            break;
                    }
                } else {
                    log(`‚ö†Ô∏è HLS Ë≠¶Âëä: ${data.type} - ${data.details}`, 'warning');
                }
            });

            hls.on(Hls.Events.BUFFER_APPENDED, () => {
                // ÁºìÂÜ≤Â∑≤ËøΩÂä†
            });

            setupVideoEvents();
        }

        async function stopStream() {
            if (hls) {
                hls.destroy();
                hls = null;
                log('Â∑≤ÂÅúÊ≠¢ HLS Êí≠Êîæ', 'warning');
            }

            video.pause();
            video.src = '';
            video.srcObject = null;

            document.getElementById('placeholder').style.display = 'block';

            updateStatus('currentUrl', '-');
            updateStatus('playbackState', 'Êú™Êí≠Êîæ', false);
            updateStatus('hlsState', '-');
            updateStatus('videoReady', '-');
            updateStatus('errorInfo', '-');

            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('hlsUrl').disabled = false;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('hostId').disabled = false;

            stopKeyframeRefresh();

            currentStreamUrl = null;
            currentSessionId = null; // Ê∏ÖÈô§ sessionId
            
            // Êñ≠ÂºÄ SignalR ËøûÊé•
            await disconnectControllerSignalR();
        }
        
        // ËøûÊé• SignalR ÊéßÂà∂Âô®
        async function connectControllerSignalR(sessionId) {
            try {
                const token = getAuthToken();
                if (!token) {
                    log('‚ùå Êú™Ê£ÄÊµãÂà∞ JWT TokenÔºåÊó†Ê≥ïÂª∫Á´ã SignalR ËøûÊé•', 'error');
                    return;
                }

                if (controllerConnection) {
                    await disconnectControllerSignalR();
                }
                
                log('üîå Ê≠£Âú®ËøûÊé• SignalR ÊéßÂà∂Âô®...', 'info');
                controllerConnection = new signalR.HubConnectionBuilder()
                    .withUrl('/hubs/controller', {
                        accessTokenFactory: () => getAuthToken() || ''
                    })
                    .build();
                
                // Ê≥®ÂÜå‰∫ã‰ª∂
                controllerConnection.on('ControllerConnected', (success) => {
                    log(`‚úÖ ÊéßÂà∂Âô®Â∑≤ÈÄöËøá SignalR ËøûÊé•: ${success}`, 'success');
                    controllerConnected = true;
                });
                
                controllerConnection.on('ControllerStarted', (success) => {
                    log(`‚úÖ ÊéßÂà∂Âô®Â∑≤ÂêØÂä®: ${success}`, 'success');
                });
                
                controllerConnection.on('Error', (message) => {
                    log(`‚ùå SignalR ÈîôËØØ: ${message}`, 'error');
                });
                
                controllerConnection.onclose(() => {
                    log('‚ö†Ô∏è SignalR ËøûÊé•Â∑≤ÂÖ≥Èó≠', 'warning');
                    controllerConnected = false;
                });
                
                await controllerConnection.start();
                log('‚úÖ SignalR ËøûÊé•Â∑≤Âª∫Á´ã', 'success');
                
                // ËøûÊé•ÊéßÂà∂Âô®Âà∞‰ºöËØù
                await controllerConnection.invoke('ConnectController', sessionId);
                
                // ÂêØÂä®ÊéßÂà∂Âô®
                await controllerConnection.invoke('StartController', sessionId);
                
            } catch (error) {
                log(`‚ùå SignalR ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
                controllerConnection = null;
                controllerConnected = false;
            }
        }
        
        // Êñ≠ÂºÄ SignalR ÊéßÂà∂Âô®
        async function disconnectControllerSignalR() {
            if (controllerConnection) {
                try {
                    if (currentSessionId) {
                        await controllerConnection.invoke('DisconnectController', currentSessionId);
                    }
                    await controllerConnection.stop();
                    log('‚úÖ SignalR ËøûÊé•Â∑≤Êñ≠ÂºÄ', 'info');
                } catch (error) {
                    log(`‚ö†Ô∏è Êñ≠ÂºÄ SignalR ËøûÊé•Êó∂Âá∫Èîô: ${error.message}`, 'warning');
                }
                controllerConnection = null;
                controllerConnected = false;
            }
        }

        // ÊéßÂà∂Âô®ÊåâÈíÆÂ§ÑÁêÜÂáΩÊï∞Ôºà‰ΩøÁî® SignalR ‰ΩéÂª∂ËøüÔºâ
        // action: 'press', 'release', 'tap'
        async function sendControllerButton(buttonName, action = 'tap') {
            // Â¶ÇÊûú currentSessionId ‰∏∫Á©∫ÔºåÂ∞ùËØï‰ªéÂΩìÂâçÊµÅ URL ‰∏≠ÊèêÂèñ
            if (!currentSessionId && currentStreamUrl) {
                const extractedSessionId = extractSessionIdFromUrl(currentStreamUrl);
                if (extractedSessionId) {
                    currentSessionId = extractedSessionId;
                    log(`‚úÖ ‰ªéÂΩìÂâçÊµÅ URL ‰∏≠ÊèêÂèñ‰ºöËØù ID: ${extractedSessionId}`, 'success');
                }
            }
            
            if (!currentSessionId) {
                log('‚ùå Ê≤°ÊúâÊ¥ªÂä®ÁöÑ‰ºöËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊéßÂà∂Âô®ÂëΩ‰ª§', 'error');
                alert('ËØ∑ÂÖàËøûÊé•Âπ∂ÂêØÂä®ÊµÅ\n\nÂ¶ÇÊûúÂ∑≤ËøûÊé•ÔºåËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÊàñÈáçÊñ∞ËøûÊé•');
                return;
            }

            // Â¶ÇÊûú SignalR Êú™ËøûÊé•ÔºåÂ∞ùËØïËøûÊé•
            if (!controllerConnection || !controllerConnected) {
                log('‚ö†Ô∏è SignalR Êú™ËøûÊé•ÔºåÂ∞ùËØïÈáçÊñ∞ËøûÊé•...', 'warning');
                await connectControllerSignalR(currentSessionId);
                if (!controllerConnection || !controllerConnected) {
                    log('‚ùå SignalR ËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî® HTTP API ‰Ωú‰∏∫Â§áÁî®', 'error');
                    // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî® HTTP API
                    await sendControllerButtonHTTP(buttonName, action);
                    return;
                }
            }

            try {
                const startTime = performance.now();
                const delayMs = action === 'tap' ? 100 : 0;
                await controllerConnection.invoke('Button', currentSessionId, buttonName, action, delayMs);
                const endTime = performance.now();
                const latency = (endTime - startTime).toFixed(2);
                log(`‚úÖ ÊéßÂà∂Âô®ÂëΩ‰ª§Â∑≤ÂèëÈÄÅ (SignalR): ${buttonName} [${action}] - Âª∂Ëøü: ${latency}ms`, 'success');
            } catch (error) {
                log(`‚ùå SignalR ÂèëÈÄÅÂ§±Ë¥•: ${error.message}ÔºåÂ∞ùËØï‰ΩøÁî® HTTP API`, 'error');
                // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî® HTTP API
                await sendControllerButtonHTTP(buttonName, action);
            }
        }
        
        // HTTP API Â§áÁî®ÊñπÊ°à
        async function sendControllerButtonHTTP(buttonName, action = 'tap') {
            try {
                const response = await authorizedFetch('/api/PlayStation/controller/button', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        button: buttonName,
                        action: action,
                        delayMs: action === 'tap' ? 200 : 0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    log(`‚úÖ ÊéßÂà∂Âô®ÂëΩ‰ª§Â∑≤ÂèëÈÄÅ (HTTP): ${buttonName} [${action}]`, 'success');
                } else {
                    log(`‚ö†Ô∏è ÊéßÂà∂Âô®ÂëΩ‰ª§Â§±Ë¥•: ${result.errorMessage || 'Êú™Áü•ÈîôËØØ'}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå HTTP API ÂèëÈÄÅÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }
        
        // Ë∑üË∏™ÂΩìÂâçÊåâ‰∏ãÁöÑÊåâÈíÆÔºàÁî®‰∫éÈïøÊåâÔºâ
        const pressedButtons = new Map(); // buttonName -> { pressTimer, releaseTimer }

        // ÂàùÂßãÂåñÊéßÂà∂Âô®ÊåâÈíÆ‰∫ã‰ª∂
        function initControllerButtons() {
            const controllerButtons = document.querySelectorAll('.controller-btn[data-button]');
            log(`ÂàùÂßãÂåñÊéßÂà∂Âô®ÊåâÈíÆ: ÊâæÂà∞ ${controllerButtons.length} ‰∏™ÊåâÈíÆ`, 'info');
            
            if (controllerButtons.length === 0) {
                log(`‚ö†Ô∏è Êú™ÊâæÂà∞‰ªª‰ΩïÊéßÂà∂Âô®ÊåâÈíÆÔºåËØ∑Ê£ÄÊü• HTML ÁªìÊûÑ`, 'warning');
                return;
            }
            
            controllerButtons.forEach((btn, index) => {
                const buttonName = btn.getAttribute('data-button');
                if (!buttonName) {
                    log(`‚ö†Ô∏è ÊåâÈíÆ ${index} Ê≤°Êúâ data-button Â±ûÊÄß`, 'warning');
                    return;
                }
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºàËΩªÊåâÔºåÂø´ÈÄüÊåâ‰∏ãÂπ∂ÈáäÊîæÔºâ
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    log(`üéÆ ÁÇπÂáªÊåâÈíÆ: ${buttonName}`, 'info');
                    sendControllerButton(buttonName, 'tap');
                    
                    // Ê∑ªÂä†ËßÜËßâÂèçÈ¶à
                    const originalTransform = btn.style.transform;
                    btn.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        btn.style.transform = originalTransform || '';
                    }, 100);
                }, false);
                
                // Ê∑ªÂä†Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂ÔºàÈïøÊåâÂºÄÂßãÔºâ
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.style.opacity = '0.7';
                    this.style.transform = 'scale(0.95)';
                    
                    // Â¶ÇÊûúÂ∑≤ÁªèÂú®Êåâ‰∏ãÁä∂ÊÄÅÔºåÂÖàÈáäÊîæ
                    if (pressedButtons.has(buttonName)) {
                        const existing = pressedButtons.get(buttonName);
                        if (existing.pressTimer) {
                            clearTimeout(existing.pressTimer);
                        }
                        if (existing.releaseTimer) {
                            clearTimeout(existing.releaseTimer);
                        }
                        // ÂÖàÂèëÈÄÅÈáäÊîæ
                        sendControllerButton(buttonName, 'release');
                    }
                    
                    // ÂèëÈÄÅÊåâ‰∏ã‰∫ã‰ª∂
                    sendControllerButton(buttonName, 'press');
                    
                    // ËÆ∞ÂΩïÊåâ‰∏ãÁä∂ÊÄÅ
                    pressedButtons.set(buttonName, {
                        pressTimer: null,
                        releaseTimer: null,
                        button: this
                    });
                    
                    log(`üéÆ ÊåâÈíÆÊåâ‰∏ã: ${buttonName} (ÈïøÊåâÊ®°Âºè)`, 'info');
                }, false);
                
                // Ê∑ªÂä†Èº†Ê†áÈáäÊîæ‰∫ã‰ª∂ÔºàÈïøÊåâÁªìÊùüÔºâ
                btn.addEventListener('mouseup', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.style.opacity = '1';
                    this.style.transform = '';
                    
                    // Â¶ÇÊûúÊåâÈíÆÂú®Êåâ‰∏ãÁä∂ÊÄÅÔºåÂèëÈÄÅÈáäÊîæ
                    if (pressedButtons.has(buttonName)) {
                        sendControllerButton(buttonName, 'release');
                        pressedButtons.delete(buttonName);
                        log(`üéÆ ÊåâÈíÆÈáäÊîæ: ${buttonName}`, 'info');
                    }
                }, false);
                
                // Èº†Ê†áÁ¶ªÂºÄÊó∂‰πüÈáäÊîæ
                btn.addEventListener('mouseleave', function(e) {
                    this.style.opacity = '1';
                    this.style.transform = '';
                    
                    // Â¶ÇÊûúÊåâÈíÆÂú®Êåâ‰∏ãÁä∂ÊÄÅÔºåÂèëÈÄÅÈáäÊîæ
                    if (pressedButtons.has(buttonName)) {
                        sendControllerButton(buttonName, 'release');
                        pressedButtons.delete(buttonName);
                        log(`üéÆ ÊåâÈíÆÁ¶ªÂºÄÈáäÊîæ: ${buttonName}`, 'info');
                    }
                }, false);
                
                // Ëß¶Êë∏‰∫ã‰ª∂ÊîØÊåÅÔºàÁßªÂä®ËÆæÂ§áÔºâ
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
                }, false);
                
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
                }, false);
                
                log(`‚úÖ Â∑≤ÁªëÂÆöÊåâÈíÆ: ${buttonName} (ÊîØÊåÅÈïøÊåâ)`, 'info');
            });
            
            log(`‚úÖ ÊéßÂà∂Âô®ÊåâÈíÆÂàùÂßãÂåñÂÆåÊàêÔºåÂÖ±ÁªëÂÆö ${controllerButtons.length} ‰∏™ÊåâÈíÆ`, 'success');
        }

        function refreshStream() {
            if (!currentStreamUrl) {
                log('Ê≤°ÊúâÊ≠£Âú®Êí≠ÊîæÁöÑÊµÅ', 'warning');
                return;
            }

            log('Ê≠£Âú®Âà∑Êñ∞ÊµÅ...', 'info');
            const url = currentStreamUrl;
            stopStream();

            // Áü≠ÊöÇÂª∂ËøüÂêéÈáçÊñ∞Êí≠Êîæ
            setTimeout(() => {
                document.getElementById('hlsUrl').value = url.includes('/hls/') 
                    ? url.split('/hls/')[1].split('/')[0] 
                    : url;
                playStream();
            }, 500);
        }

        // ÊîØÊåÅ Enter ÈîÆÊí≠Êîæ
        document.getElementById('hlsUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                playStream();
            }
        });

        // ÊîØÊåÅ Enter ÈîÆËøûÊé•
        document.getElementById('hostId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectAndPlay();
            }
        });

        // ÈîÆÁõòÊò†Â∞ÑÈÖçÁΩÆ
        const keyboardMapping = {
            // ÊñπÂêëÈîÆ
            'KeyW': 'UP',
            'ArrowUp': 'UP',
            'KeyS': 'DOWN',
            'ArrowDown': 'DOWN',
            'KeyA': 'LEFT',
            'ArrowLeft': 'LEFT',
            'KeyD': 'RIGHT',
            'ArrowRight': 'RIGHT',
            // ‰∏ªË¶ÅÊåâÈíÆ
            'Space': 'CROSS',      // Á©∫Ê†º = ‚úï
            'Enter': 'CIRCLE',     // Enter = ‚óã (‰ΩÜÈúÄË¶ÅÈò≤Ê≠¢Âú®ËæìÂÖ•Ê°Ü‰∏≠Ëß¶Âèë)
            'ShiftLeft': 'SQUARE', // Â∑¶ Shift = ‚ñ°
            'ShiftRight': 'SQUARE',
            'ControlLeft': 'TRIANGLE', // Â∑¶ Ctrl = ‚ñ≥
            'ControlRight': 'TRIANGLE',
            // ËÇ©ÈîÆ
            'KeyQ': 'L1',
            'KeyE': 'R1',
            'KeyZ': 'L2',
            'KeyC': 'R2',
            // ÂäüËÉΩÈîÆ
            'Tab': 'OPTIONS',
            'Backspace': 'SHARE',
            'Escape': 'PS'
        };

        // Â∑≤Êåâ‰∏ãÁöÑÈîÆÔºàÁî®‰∫éÈò≤Ê≠¢ÈáçÂ§çËß¶ÂèëÔºâ
        const pressedKeys = new Set();

        // ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
        function handleKeyboardEvent(event, isKeyDown) {
            // Â¶ÇÊûúÁÑ¶ÁÇπÂú®ËæìÂÖ•Ê°ÜÊàñÊñáÊú¨Âå∫ÂüüÔºå‰∏çÂ§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂ÔºàÈô§‰∫Ü EscapeÔºâ
            const activeElement = document.activeElement;
            const isInputFocused = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.isContentEditable
            );

            // Escape ÈîÆÂßãÁªàÂ§ÑÁêÜÔºàÁî®‰∫éÈÄÄÂá∫ËæìÂÖ•Ê°ÜÔºâ
            if (event.key === 'Escape' || event.code === 'Escape') {
                if (isInputFocused) {
                    activeElement.blur();
                }
                // ÁªßÁª≠Â§ÑÁêÜ Escape ÈîÆÊò†Â∞Ñ
            } else if (isInputFocused) {
                // ÂÖ∂‰ªñÈîÆÂú®ËæìÂÖ•Ê°Ü‰∏≠Êó∂‰∏çÂ§ÑÁêÜ
                return;
            }

            // Èò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫ÔºàÊüê‰∫õÈîÆÔºâ
            const keyCode = event.code || event.key;
            if (keyboardMapping[keyCode]) {
                // ÂØπ‰∫éÊüê‰∫õÈîÆÔºåÈò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫
                if (['Space', 'Tab', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(keyCode)) {
                    event.preventDefault();
                }
            }

            // Â§ÑÁêÜÊåâÈîÆ
            const buttonName = keyboardMapping[keyCode];
            if (buttonName) {
                if (isKeyDown) {
                    // Êåâ‰∏ãÊó∂Âè™Ëß¶Âèë‰∏ÄÊ¨°ÔºàÈò≤Ê≠¢ÈáçÂ§çÔºâ
                    if (!pressedKeys.has(keyCode)) {
                        pressedKeys.add(keyCode);
                        
                        // È´ò‰∫ÆÂØπÂ∫îÁöÑÊåâÈíÆ
                        const btn = document.querySelector(`.controller-btn[data-button="${buttonName}"]`);
                        if (btn) {
                            btn.style.opacity = '0.7';
                            btn.style.transform = 'scale(0.95)';
                        }
                        
                        // ÂèëÈÄÅÊåâ‰∏ã‰∫ã‰ª∂ÔºàÈïøÊåâÊ®°ÂºèÔºâ
                        log(`‚å®Ô∏è ÈîÆÁõòÊåâ‰∏ã: ${keyCode} -> ${buttonName} (ÈïøÊåâÊ®°Âºè)`, 'info');
                        sendControllerButton(buttonName, 'press');
                    }
                } else {
                    // ÈáäÊîæÊó∂ÁßªÈô§Ê†áËÆ∞
                    if (pressedKeys.has(keyCode)) {
                        pressedKeys.delete(keyCode);
                        
                        // ÊÅ¢Â§çÊåâÈíÆÊ†∑Âºè
                        const btn = document.querySelector(`.controller-btn[data-button="${buttonName}"]`);
                        if (btn) {
                            btn.style.opacity = '1';
                            btn.style.transform = '';
                        }
                        
                        // ÂèëÈÄÅÈáäÊîæ‰∫ã‰ª∂
                        log(`‚å®Ô∏è ÈîÆÁõòÈáäÊîæ: ${keyCode} -> ${buttonName}`, 'info');
                        sendControllerButton(buttonName, 'release');
                    }
                }
            }
        }

        // ÂàùÂßãÂåñÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
        function initKeyboardMapping() {
            // ÁõëÂê¨ÈîÆÁõòÊåâ‰∏ã
            document.addEventListener('keydown', (event) => {
                handleKeyboardEvent(event, true);
            }, false);

            // ÁõëÂê¨ÈîÆÁõòÈáäÊîæ
            document.addEventListener('keyup', (event) => {
                handleKeyboardEvent(event, false);
            }, false);

            // È°µÈù¢Â§±ÂéªÁÑ¶ÁÇπÊó∂Ê∏ÖÈô§ÊâÄÊúâÊåâÈîÆÁä∂ÊÄÅ
            window.addEventListener('blur', () => {
                // ÈáäÊîæÊâÄÊúâÊåâ‰∏ãÁöÑÊåâÈíÆ
                pressedKeys.forEach(keyCode => {
                    const buttonName = keyboardMapping[keyCode];
                    if (buttonName) {
                        sendControllerButton(buttonName, 'release');
                    }
                });
                pressedKeys.clear();
                
                // ÈáäÊîæÊâÄÊúâÈº†Ê†áÊåâ‰∏ãÁöÑÊåâÈíÆ
                pressedButtons.forEach((value, buttonName) => {
                    sendControllerButton(buttonName, 'release');
                });
                pressedButtons.clear();
                
                // ÊÅ¢Â§çÊâÄÊúâÊåâÈíÆÊ†∑Âºè
                document.querySelectorAll('.controller-btn').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.transform = '';
                });
            });

            log('‚úÖ ÈîÆÁõòÊò†Â∞ÑÂ∑≤ÂàùÂßãÂåñ', 'success');
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÁöÑÂàùÂßãÂåñ
        window.addEventListener('load', () => {
            updateAuthTokenStatus();
            log('HLS Player Â∑≤Â∞±Áª™', 'success');
            log('ËØ∑ËæìÂÖ• HLS URL Êàñ Session ID Âπ∂ÁÇπÂáªÊí≠Êîæ', 'info');
            
            // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
            if (Hls.isSupported()) {
                log('‚úÖ HLS.js Â∑≤Âä†ËΩΩÂπ∂ÊîØÊåÅ', 'success');
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                log('‚úÖ ÊµèËßàÂô®ÂéüÁîüÊîØÊåÅ HLS', 'success');
            } else {
                log('‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅ HLS Êí≠Êîæ', 'error');
            }
            
            // ÂàùÂßãÂåñÊéßÂà∂Âô®ÊåâÈíÆ
            initControllerButtons();
            
            // ÂàùÂßãÂåñÈîÆÁõòÊò†Â∞Ñ
            initKeyboardMapping();
        });

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
        window.addEventListener('beforeunload', () => {
            stopStream();
        });
    </script>
</body>
</html>

